# Level 5: A Subterranean Struggle

[scenario]
#textdomain wesnoth-Under_the_Burning_Suns

id="Struggle"
name= _ "A Subterranean Struggle"
label= _ "A Subterranean Struggle"

{DESERTMAP 5Struggle7}

#display snapshot of map in saved games
snapshot="no"

#max turns is 115/105/95 depending on difficulty
#ifdef EASY
turns="115"
#endif
#ifdef MEDIUM
turns="105"
#endif
#ifdef HARD
turns="95"
#endif

victory_when_enemies_defeated=no

{UNDERGROUND}

# side=1 income was originally 12,9,7

[side]
	side=1
	description=Kaleh
	type=Desert Fighter
	canrecruit=1
	{INCOME 8 6 6}
	controller=human
	#recruit=Desert Fighter3, Desert Archer3, Desert Hunter3, Desert Shaman3, Desert Scout3
	shroud=yes
	fog=no
[/side]

#Side=2Êtroll 1 (blue)
[side]
	no_leader=yes
	side=2
	gold=0
	income=0
	controller=ai
	shroud=yes
	fog=no
	team_name=troll

	#ifdef EASY
	recruit=Troll Whelp2, Troll2, Troll Rocklobber2
	#endif

	#ifdef MEDIUM
	recruit=Troll Whelp2, Troll2, Troll Rocklobber2
	#endif

	#ifdef HARD
	recruit=Troll Whelp2, Troll2, Troll Rocklobber2
	#endif

	[ai]
		#ifdef EASY
		recruitment_pattern=fighter,archer,fighter,mixed fighter
		#endif

		#ifdef MEDIUM
		recruitment_pattern=fighter,archer,fighter,mixed fighter
		#endif

		#ifdef HARD
		recruitment_pattern=fighter,archer,fighter,mixed fighter
		#endif

		aggression=0.6
		caution=0.1

		# AI will attack a weak unit with a max of 3,4,5 units
		# depending on the difficulty (default=5)
		{ATTACK_DEPTH 3 4 5}

		[target]
		side=1
		value=10
		[/target]

		[target]
		side=4
		value=9
		[/target]

		[target]
		side=5
		value=9
		[/target]

		#get troll to attack dwarf prisoner
		[target]
		description=Rogrimir
		value=25
		[/target]

		[protect_location]
		x=19-51
		y=34-77
		target=10
		[/protect_location]

		#avoid passage past SE troll base
		[avoid]
		x,y=40-54,77-90
		[/avoid]

		#avoid passages past dwarf bases
		#NE passage
		[avoid]
		x,y=34-44,20-32
		[/avoid]

		#NW passage
		[avoid]
		x,y=28-40,1-34
		[/avoid]
	[/ai]
[/side]


#Side=3 troll 2 (green)
[side]
	side=3
	no_leader=yes
	gold=0
	income=0
	controller=ai
	shroud=no
	fog=no
	team_name=troll

	#ifdef EASY
	recruit=Troll Whelp2, Troll2, Troll Rocklobber2
	#endif

	#ifdef MEDIUM
	recruit=Troll Whelp2, Troll2, Troll Rocklobber2
	#endif

	#ifdef HARD
	recruit=Troll Whelp2, Troll2, Troll Rocklobber2
	#endif

	[ai]
		#ifdef EASY
		recruitment_pattern=fighter,archer,fighter,mixed fighter
		#endif

		#ifdef MEDIUM
		recruitment_pattern=fighter,archer,fighter,mixed fighter
		#endif

		#ifdef HARD
		recruitment_pattern=fighter,archer,fighter,mixed fighter
		#endif


		# AI will attack a weak unit with a max of 3,4,5 units
		# depending on the difficulty (default=5)
		{ATTACK_DEPTH 3 4 5}

		aggression=0.6
		caution=0.1

		[target]
		side=1
		value=10
		[/target]

		[target]
		side=4
		value=9
		[/target]

		[target]
		side=5
		value=9
		[/target]

		[protect_location]
		x=19-51
		y=34-77
		target=10
		[/protect_location]

		#avoid passage past SE troll base
		[avoid]
		x,y=40-54,77-90
		[/avoid]

		#avoid passages past dwarf bases
		#NE passage
		[avoid]
		x,y=34-44,20-32
		[/avoid]

		#NW passage
		[avoid]
		x,y=28-40,1-34
		[/avoid]

	[/ai]
[/side]

#Side=4 dwarf 1 (yellow)
[side]
	side=4
	no_leader=yes
	gold=0
	income=0
	controller=ai
	shroud=no
	fog=no
	team_name=dwarf

	#ifdef EASY
	recruit=Dwarvish Fighter, Dwarvish Steelclad, Dwarvish Thunderer, Dwarvish Guardsman
	#endif

	#ifdef MEDIUM
	recruit=Dwarvish Fighter, Dwarvish Steelclad, Dwarvish Thunderer, Dwarvish Guardsman
	#endif

	#ifdef HARD
	recruit=Dwarvish Fighter, Dwarvish Steelclad, Dwarvish Thunderer, Dwarvish Guardsman
	#endif

	[ai]
		#ifdef EASY
		#recruitment_pattern=scout,fighter,archer,fighter
		#endif

		#ifdef MEDIUM
		#recruitment_pattern=scout,fighter,archer,fighter
		#endif

		#ifdef HARD
		#recruitment_pattern=scout,fighter,archer,fighter
		#endif

		# AI will attack a weak unit with a max of 3,4,5 units
		# depending on the difficulty (default=5)
		{ATTACK_DEPTH 3 4 5}

		aggression=0.6
		caution=0.1

		[target]
		side=1
		value=10
		[/target]

		[target]
		side=2
		value=9
		[/target]

		[target]
		side=3
		value=9
		[/target]

		#get dwarf to attack troll prisoner
		[target]
		description=Grog
		value=25
		[/target]

		[protect_location]
		x=19-51
		y=34-77
		target=10
		[/protect_location]

		#avoid passage past SE troll base
		[avoid]
		x,y=40-54,77-90
		[/avoid]

		#avoid passages past dwarf bases
		#NE passage
		[avoid]
		x,y=34-44,20-32
		[/avoid]

		#NW passage
		[avoid]
		x,y=28-40,1-34
		[/avoid]
	[/ai]
[/side]


#Side=5 dwarf 2 (purple)
[side]
	side=5
	no_leader=yes
	gold=0
	income=0
	controller=ai
	shroud=no
	fog=no
	team_name=dwarf

	#ifdef EASY
	recruit=Dwarvish Fighter, Dwarvish Steelclad, Dwarvish Thunderer, Dwarvish Guardsman
	#endif

	#ifdef MEDIUM
	recruit=Dwarvish Fighter, Dwarvish Steelclad, Dwarvish Thunderer, Dwarvish Guardsman
	#endif

	#ifdef HARD
	recruit=Dwarvish Fighter, Dwarvish Steelclad, Dwarvish Thunderer, Dwarvish Guardsman
	#endif

	[ai]
		#ifdef EASY
		#recruitment_pattern=scout,fighter,archer,fighter
		#endif

		#ifdef MEDIUM
		#recruitment_pattern=scout,fighter,archer,fighter
		#endif

		#ifdef HARD
		#recruitment_pattern=scout,fighter,archer,fighter
		#endif

		# AI will attack a weak unit with a max of 3,4,5 units
		# depending on the difficulty (default=5)
		{ATTACK_DEPTH 3 4 5}

		aggression=0.6
		caution=0.1

		[target]
		side=1
		value=10
		[/target]

		[target]
		side=2
		value=9
		[/target]

		[target]
		side=3
		value=9
		[/target]

		[protect_location]
		x=19-51
		y=34-77
		target=10
		[/protect_location]

		#avoid passage past SE troll base
		[avoid]
		x,y=40-54,77-90
		[/avoid]

		#avoid passages past dwarf bases
		#NE passage
		[avoid]
		x,y=34-44,20-32
		[/avoid]

		#NW passage
		[avoid]
		x,y=28-40,1-34
		[/avoid]
	[/ai]
[/side]

#Side=6 dwarf 3 (orange)
[side]
	side=6
	no_leader=yes
	gold=0
	income=0
	controller=ai
	shroud=no
	fog=no
	#so that lake bats won't go after dwarves
	team_name=monster

	#ifdef EASY
	recruit=Dwarvish Fighter, Dwarvish Steelclad, Dwarvish Thunderer, Dwarvish Berserker, Dwarvish Thunderguard, Dwarvish Guardsman, Dwarvish Pathfinder, 
	#endif

	#ifdef MEDIUM
	recruit=Dwarvish Fighter, Dwarvish Steelclad, Dwarvish Thunderer, Dwarvish Berserker, Dwarvish Thunderguard, Dwarvish Guardsman, Dwarvish Pathfinder, Dwarvish Explorer

	#endif

	#ifdef HARD
	recruit=Dwarvish Fighter, Dwarvish Steelclad, Dwarvish Thunderer, Dwarvish Berserker, Dwarvish Thunderguard, Dwarvish Guardsman, Dwarvish Dragonguard, Dwarvish Sentinel, Dwarvish Pathfinder, Dwarvish Explorer

	#endif

	[ai]
		#ifdef EASY
		recruitment_pattern=scout,fighter,archer,fighter
		#endif

		#ifdef MEDIUM
		recruitment_pattern=scout,fighter,archer,fighter
		#endif

		#ifdef HARD
		recruitment_pattern=scout,fighter,archer,fighter
		#endif

		# AI will attack a weak unit with a max of 3,4,5 units
		# depending on the difficulty (default=5)
		{ATTACK_DEPTH 3 4 5}

		aggression=0.6
		
		# makes the dwarves group defensively
		grouping=defensive

		[avoid]
		x=1-67
		y=28-40
		[/avoid]

	[/ai]
[/side]


#Side=7 troll 3 (grey)
[side]
	side=7
	no_leader=yes
	gold=0
	income=0
	controller=ai
	shroud=no
	fog=no
	team_name=monster

	#ifdef EASY
	recruit=Troll Whelp2, Troll2, Troll Rocklobber2, Troll Shaman
	#endif

	#ifdef MEDIUM
	recruit=Troll Whelp2, Troll2, Troll Rocklobber2, Troll Shaman
	#endif

	#ifdef HARD
	recruit=Troll Whelp2, Troll2, Troll Rocklobber2, Troll Shaman
	#endif

	[ai]
		#ifdef EASY
		recruitment_pattern=fighter,archer,fighter,mixed fighter
		#endif

		#ifdef MEDIUM
		recruitment_pattern=fighter,archer,fighter,mixed fighter
		#endif

		#ifdef HARD
		recruitment_pattern=fighter,archer,fighter,mixed fighter
		#endif

		# AI will attack a weak unit with a max of 3,4,5 units
		# depending on the difficulty (default=5)
		{ATTACK_DEPTH 3 4 5}

		aggression=0.6
	[/ai]
[/side]


#Side=8 vampire bats/ants/fire guardians (white)
[side]
	side=8
	no_leader=yes
	gold=0
	income=0
	controller=ai
	shroud=no
	fog=no
	team_name=monster

	#ifdef EASY
	recruit=Vampire Bat2, Blood Bat2
	#endif

	#ifdef MEDIUM
	recruit=Vampire Bat2, Blood Bat2, Dread Bat
	#endif

	#ifdef HARD
	recruit=Vampire Bat2, Blood Bat2, Dread Bat
	#endif

	[ai]
		aggression=0.8
		caution=0.1

		village_value=0

		# AI will attack a weak unit with a max of 3,4,5 units
		# depending on the difficulty (default=5)
		{ATTACK_DEPTH 3 4 5}

		recruitment_pattern=fighter,fighter,fighter,fighter
		recruitment_ignore_bad_combat=yes

		#bats can't go down SW tunnel
		[avoid]
		x,y=24-42, 23-50
		[/avoid]

		#bats cant go west and attack dwarves
		[avoid]
		x,y=33-35,13-15
		[/avoid]

		#fire guardians can't leave lava cavern
		[avoid]
		x,y=39-46,77-81
		[/avoid]

		[avoid]
		x,y=30-34,92-100
		[/avoid]

		[target]
		type=Cave Spider
		value=150
		[/target]

		[target]
		side=1
		value=100
		[/target]

		[protect_location]
		x=28-48
		y=81-95
		target=200
		[/protect_location]

		passive_leader=yes
	[/ai]
[/side]

#Side=9 Assassin & Secrets & Cave Spider & Tentacles (brown) 
[side]
	side=9
	no_leader=yes
	gold=0
	income=0
	controller=ai
	shroud=yes
	fog=no
	team_name=monster

	[ai]
		# AI will attack a weak unit with a max of 4,5,6 units
		# depending on the difficulty (default=5)
		{ATTACK_DEPTH 3 4 5}

		aggression=0.90
		caution=0.10
	[/ai]

	[target]
	description=Kaleh
	value=20
	[/target]

[/side]

[story]
	[part] 
	story= _ "Chapter 5: We plunged into the darkness, shepherding long lines of our people along the cramped passageway deeper and deeper beneath the roots of the mountains. We had brought along palm torches, and we had scavenged other torches from the orcs, so we had enough light sources, at least for the moment. Even so, the guttering torches shed little light, and shadows flickered everywhere. The walls were damp and clammy, the air seemed stale and the sound of our footsteps echoed up and down the passageway." 
	[/part]

	[part]
	story= _ "This seemed about as alien an environment as we could ever be in. We were people of the open sands, and even during the long dark we could look up and orient ourselves by the stars glittering brightly in their heights. I knew logically that we could not go over those frozen mountains, and we could not go back, but I shivered at the thought of miles and miles of rock above me, and felt the weight of the mountain closing around me. The passage twisted and turned, and soon I lost all sense of direction, but since there were no side-passages, we had little choice but to keep going forward." 
	[/part]

	[part]
	story= _ "Looking back, I think the bravest thing that my people ever did was to follow me into the darkness solely on the promises of Eloh and their faith in my leadership. I had no idea how long we would be trapped underground, or even which way we should go. I just hoped Eloh would guide us somehow. Nym said that people whispered that I could lead them through anything, and it was true that when we left I had hardly imagined that we would fight outlaws, undead, orcs and goblins. My previous life seemed like years ago, even though it had only been ten days since our village was demolished." 
	[/part]

	[part]
	story= _ "What lurked in the darkness? Who were the unbelievers that Eloh so cryptically referred to? My heart beat loudly in my chest, everything seemed amplified down here. I had the strong suspicion that this was not a place that my people were meant to be. I strode onwards grimly; considering everything we had gone through so far, Zardia be damned if I was going to be frightened now." 
	[/part]
[/story]


#define ELFTEST

[unit]
	type=Desert Fighter
	description=Test
	#canrecruit=1
	upkeep=free
	x=23
	y=56
	side=1
[/unit]

	[unit]
	type=Desert Archer
	description=Sylestria
	upkeep=full
	gender=female
	x=22
	y=56
	side=1
	[/unit]

#enddef

# Prestart functions:
# set starting scenario objectives
# increase cost of recruiting units
# place item images on map
# recall main heroes
# initialize starting variables
# remove keep
# create elf units
# create AI=guardian starting units

[event]
name=prestart

	#Testing characters

	#{ELFTEST}

	#{UNIT_ (Troll2) (Test) 1 17 33} 
	#{UNIT_ (Desert Champion) (Test) 1 9 36} 
	#{UNIT_ (Great Troll2) (Test) 1 44 34}
	#{UNIT_ (Great Troll2) (Test) 1 26 35}

	#lake tests
	#{UNIT_ (Desert Prowler) (Test) 1 43 17}
	#{UNIT_ (Desert Prowler) (Test) 1 43 18}
	#{UNIT_ (Desert Champion) (Test) 1 43 19} 
	#{UNIT_ (Desert Prowler) (Test) 1 40 13}
	#{UNIT_ (Desert Shyde) (Test) 1 46 17}
	#{UNIT_ (Desert Star) (Test) 1 58 20}
	#{UNIT_ (Desert Star) (Test) 1 35 13}

	#secret dwarven tomb test
	#{UNIT_ (Desert Star) (Test) 1 66 24} 

	#lava tests
	#{UNIT_ (Desert Star) (Test) 1 40 80}
	#{UNIT_ (Dwarvish Explorer) (Test) 1 40 81}
	#{UNIT_ (Desert Prowler) (Test) 1 40 82}
	
	#extra testing units used to test lava monsters difficulty
	#{UNIT_ (Dwarvish Steelclad) (Test) 1 40 83}
	#{UNIT_ (Dwarvish Steelclad) (Test) 1 41 83}
	#{UNIT_ (Elvish Avenger) (Test) 1 41 82}

	#{UNIT_ (Desert Star) (Test) 1 46 85}
	#{UNIT_ (Desert Star) (Test) 1 33 84}
	#{UNIT_ (Desert Star) (Test) 1 29 89}

	#lava easter egg test
	#{UNIT_ (Desert Star) (Test) 1 25 88}

	#inside troll secret tomb
	#{UNIT_ (Desert Star) (Test) 1 42 97}

	#troll final lair test
	#{UNIT_ (Desert Star) (Test) 1 39 97}

	#troll interrogators test
	#{UNIT_ (Troll Shaman) (Test) 1 24 73} 
	#{UNIT_ (Desert Hero) (Test) 1 25 74} 
	#{UNIT_ (Dwarvish Explorer) (Test) 1 26 73}
	#{UNIT_ (Desert Star) (Test) 1 25 73}

	#dwarf conscript test
	#{UNIT_ (Great Troll) (Test) 1 20 39}
	#{UNIT_ (Dwarvish Explorer) (Test) 1 11 35}

#set starting scenario objectives

[objectives] 
	summary= _ "Starting Objectives:" 
	[objective] 
		description= _ "Explore Underground" 	
		condition=win 	
	[/objective]
	[objective] 
		description= _ "Defeat all Enemies" 	
		condition=win 	
	[/objective] 
	[objective] 
		description= _ "Death of Kaleh, Nym or Zhul" 
		condition=lose 
	[/objective] 
[/objectives]


	#increase the cost of all units by 1
	[if]

		[variable]
		name=scen3
		numerical_equals=2
		[/variable]

		[then]

		#go from 2 to 3

		[disallow_recruit]
			type=Desert Fighter, Desert Archer, Desert Hunter, Desert Shaman, Desert Scout
			side=1
		[/disallow_recruit]

		[disallow_recruit]
			type=Desert Fighter2, Desert Archer2, Desert Hunter2, Desert Shaman2, Desert Scout2
			side=1
		[/disallow_recruit]

		[allow_recruit]
			type=Desert Fighter3, Desert Archer3, Desert Hunter3, Desert Shaman3, Desert Scout3
			side=1
		[/allow_recruit]
		
		[/then]

		[else]

		[if]
			[variable]
			name=scen3
			numerical_equals=1
			[/variable]

			[then]

			#go from 1 to 2

			[disallow_recruit]
				type=Desert Fighter, Desert Archer, Desert Hunter, Desert Shaman, Desert Scout
				side=1
			[/disallow_recruit]

			[allow_recruit]
				type=Desert Fighter2, Desert Archer2, Desert Hunter2, Desert Shaman2, Desert Scout2
				side=1
			[/allow_recruit]

			[/then]
		[/if]
		
		[if]
			[variable]
			name=scen3
			numerical_equals=3
			[/variable]

			[then]

			#go from 3 to 4

			[disallow_recruit]
				type=Desert Fighter, Desert Archer, Desert Hunter, Desert Shaman, Desert Scout
				side=1
			[/disallow_recruit]

			[disallow_recruit]
				type=Desert Fighter2, Desert Archer2, Desert Hunter2, Desert Shaman2, Desert Scout2
				side=1
			[/disallow_recruit]

			[disallow_recruit]
				type=Desert Fighter3, Desert Archer3, Desert Hunter3, Desert Shaman3, Desert Scout3
				side=1
			[/disallow_recruit]

			[allow_recruit]
				type=Desert Fighter4, Desert Archer4, Desert Hunter4, Desert Shaman4, Desert Scout4
				side=1
			[/allow_recruit]

			[/then]

			[else]
			# if the variable scen3 does not exist
			# because the savefile is from an older version 
			# of the campaign before scen3 was introduced,

			# then I make the middle-ground the default
			# and set scen3=2 for future scenarios

			#go from 2 to 3

			[disallow_recruit]
				type=Desert Fighter, Desert Archer, Desert Hunter, Desert Shaman, Desert Scout
				side=1
			[/disallow_recruit]

			[disallow_recruit]
				type=Desert Fighter2, Desert Archer2, Desert Hunter2, Desert Shaman2, Desert Scout2
				side=1
			[/disallow_recruit]

			[allow_recruit]
				type=Desert Fighter3, Desert Archer3, Desert Hunter3, Desert Shaman3, Desert Scout3
				side=1
			[/allow_recruit]

			[set_variable]
			name=scen3
			value=2
			[/set_variable]

			[/else]
		[/if]

		[/else]
	[/if]


	#central cavern furnishings

	{PUT_IMG items/rock-cairn.png 42 48}
	{PUT_IMG items/rock-cairn.png 38 47}
	{PUT_IMG items/rock-cairn.png 30 47}

	{PUT_IMG items/burial.png 27 60}
	{PUT_IMG items/burial.png 35 61}
	{PUT_IMG items/burial.png 43 60}

	#secret tomb furnishings
	{PUT_IMG items/rune-violet2.png 61 21}
	{PUT_IMG items/coffin2.png 65 24}
	{PUT_IMG items/coffin2.png 19 97}

	#troll burial grounds furnishings

	{PUT_IMG items/burial.png 52 97}
	{PUT_IMG items/burial.png 49 94}
	{PUT_IMG items/burial.png 56 92}

	{PUT_IMG items/bonestack.png 53 92}
	{PUT_IMG items/bonestack.png 55 96}

	{PUT_IMG items/monolith1.png 50 94}
	{PUT_IMG items/monolith4.png 50 96}

	#other furnishings
	{PUT_IMG items/bones.png 30 81}
	
	#recall heroes
	[recall]
	description=Nym
	[/recall]
	[recall]
	description=Zhul
	[/recall]
	[recall]
	description=Elyssa
	[/recall]

	#initialize starting variables

	[set_variable]
	name=rog_died
	value=0
	[/set_variable]

	[set_variable]
	name=grog_died
	value=0
	[/set_variable]

	[set_variable]
	name=battle_turn_counter
	value=0
	[/set_variable]

	[set_variable]
	name=elvish_ally
	value=0
	[/set_variable]

	[set_variable]
	name=saw_cairn_or_totem
	value=0
	[/set_variable]

	[set_variable]
	name=saw_sergeant
	value=0
	[/set_variable]

	[set_variable]
	name=saw_troll_prisoner
	value=0
	[/set_variable]

	[set_variable]
	name=saw_interrogators
	value=0
	[/set_variable]

	[set_variable]
	name=saw_dwarf_prisoner
	value=0
	[/set_variable]

	[set_variable]
	name=dead_dwarf_leaders
	value=0
	[/set_variable]

	[set_variable]
	name=dead_troll_leaders
	value=0
	[/set_variable]

	[set_variable]
	name=first_tunnel
	value=1
	[/set_variable]

	[set_variable]
	name=bridge_blown
	value=0
	[/set_variable]

	[set_variable]
	name=tripped_bats
	value=0
	[/set_variable]

	[set_variable]
	name=tentacle_count
	value=0
	[/set_variable]

	[set_variable]
	name=tentacle_deaths
	value=0
	[/set_variable]

	[set_variable]
	name=entered_dwarf_lair
	value=0
	[/set_variable]

	[set_variable]
	name=entered_troll_lair
	value=0
	[/set_variable]

	[set_variable]
	name=dwarf_door
	value=0
	[/set_variable]

	[set_variable]
	name=dwarf_amulet
	value=0
	[/set_variable]

	[set_variable]
	name=took_belt
	value=0
	[/set_variable]

	#ifdef EASY
	[set_variable]
	name=lava_damage
	value=-25
	[/set_variable]
	#else
	[set_variable]
	name=lava_damage
	value=-30
	[/set_variable]
	#endif

	#ifdef EASY
	[set_variable]
	name=heat_damage
	value=-2
	[/set_variable]
	#endif

	#ifdef MEDIUM
	[set_variable]
	name=heat_damage
	value=-3
	[/set_variable]
	#endif

	#ifdef HARD
	[set_variable]
	name=heat_damage
	value=-4
	[/set_variable]
	#endif

	[set_variable]
	name=summon_flame
	value=0
	[/set_variable]

	[set_variable]
	name=flame_counter
	value=0
	[/set_variable]

	[set_variable]
	name=troll_undead_arose
	value=0
	[/set_variable]

	[set_variable]
	name=met_ghost
	value=0
	[/set_variable]

	[set_variable]
	name=buried_dwarf
	value=0
	[/set_variable]

	[set_variable]
	name=took_wand
	value=0
	[/set_variable]

	#assassin_turn must be 2 or greater to fire

	{RANDOM 30..40}
		
	[set_variable]
	name=assassin_turn
	value=$random
	[/set_variable]

	[set_variable]
	name=call_assassin
	value=0
	[/set_variable]
	
	[set_variable]
	name=found_empty_hex
	value=0
	[/set_variable]

	[set_variable]
	name=unit_in_hex
	value=0
	[/set_variable]

	[set_variable]
	name=immortal_hero
	value=0
	[/set_variable]
	
	[set_variable]
	name=unslow_kaleh
	value=0
	[/set_variable]

	#remove keep
	[terrain]
	x,y=5,51
	letter=u
	[/terrain]

	#create starting elves
	[unit]
	type=Desert Fighter
	description=Nantheos
	upkeep=full
	x=4
	y=50
	side=1
	[modifications]
		{TRAIT_QUICK}
		{TRAIT_STRONG}
	[/modifications]
	[/unit]

	[unit]
	type=Desert Archer
	description=Sylestria
	upkeep=full
	x=5
	y=52
	side=1
	[modifications]
		{TRAIT_INTELLIGENT}
		{TRAIT_DEXTROUS}
	[/modifications]
	traits_description="intelligent, resilient" 
	[/unit]

	#if Elyssa the Mage isn't there, boost starting group a bit

	[if]
		[not]
		[have_unit]
			description=Elyssa
		[/have_unit]
		[/not]
	
		[then]

		[unit]
		type=Desert Ranger
		description=Rygar
		x=6
		y=51
		side=1
		[modifications]
			{TRAIT_LOYAL}
			{TRAIT_STRONG}
		[/modifications]
		[/unit]

		[/then]
	[/if]

	# create AI=guardian units. They can't move unless an enemy
	# moves nearby. I create them at the beginning because when the
	# player sees them, events will fire.
	
	# used for troll and dwarf prisoner events

	# Event 7
	# Dwarvish sergeant guardian
	
	# if Normal difficulty make sergeant a Dwarvish fighter, 
	# otherwise make him a Dwarvish Steelclad

	#ifdef EASY
	[unit]
	type=Dwarvish Fighter
	description=Dwarf Sergeant
	x=14
	y=36
	side=4
	ai_special=guardian
	[modifications]
		{TRAIT_STRONG}
		{TRAIT_RESILIENT}
	[/modifications]
	[/unit]

	#else

	[unit]
	type=Dwarvish Steelclad
	description=Dwarf Sergeant
	x=14
	y=36
	side=4
	ai_special=guardian
	[modifications]
		{TRAIT_STRONG}
		{TRAIT_RESILIENT}
	[/modifications]
	[/unit]

	#endif

	# Event 8
	# Vengeful dwarf guardian

	[unit]
	type=Dwarvish Fighter
	description=Vengeful Dwarf
	x=8
	y=30
	side=4
	ai_special=guardian
	[modifications]
		{TRAIT_RESILIENT}
		{TRAIT_QUICK}
	[/modifications]
	[/unit]
	
	# Event 11
	#Troll interrogators guardian

	[unit]
	type=Troll2
	description=Troll Interrogator
	x=14
	y=73
	side=2 
	ai_special=guardian
	[modifications]
		{TRAIT_STRONG}
		{TRAIT_INTELLIGENT}
	[/modifications]
	[/unit]

	[unit]
	type=Troll Whelp2
	description=Troll Assistant
	x=16
	y=73
	side=2 
	ai_special=guardian
	[modifications]
		{TRAIT_RESILIENT}
		{TRAIT_LOYAL}
	[/modifications]
	[/unit]

	[unit]
	type=Troll Whelp2
	description=Ulg
	x=15
	y=75
	side=2 
	ai_special=guardian
	[modifications]
		{TRAIT_STRONG}
		{TRAIT_INTELLIGENT}
	[/modifications]
	[/unit]

	#ifdef HARD
	[unit]
	type=Troll Whelp2
	description=Troll Assistant
	x=17
	y=73
	side=2 
	ai_special=guardian
	[modifications]
		{TRAIT_STRONG}
		{TRAIT_RESILIENT}
	[/modifications]
	[/unit]
	#endif

	# Event 12	
	#Ulg (troll jailer) guardian

	[unit]
	type=Troll Whelp2
	description=Ulg
	x=8
	y=72
	side=2 
	ai_special=guardian
	[modifications]
		{TRAIT_STRONG}
		{TRAIT_LOYAL}
	[/modifications]
	[/unit]

[/event]

# starting events

# 1. create some villages manually, so that early finish bonus counts
# only the number of villages that a player can control

# 2. starting dialogue

[event]
name=start

	#create villages
	# I create some villages manually so that at the end
	# of the scenario extra villages which the player never
	# encounters won't be added to his early finish bonus
	
	# there are 2 villages associated with the secret areas (the troll
	# tomb village and the dwarf hermit village). The player will
	# only encounter one of them, so to keep him from getting double
	# the early finish bonus that he should, I make one of them 
	# manually so it doesn't count.

	# troll tomb village
	[terrain]
	x,y=25,94
	letter=D
	[/terrain]

	# likewise each final boss's lair has 5 villages, the player
	# will only encounter one set of villages, so to make sure
	# that only one set is added to the early finish bonus, I
	# will create one set manually.

	# great troll lair villages
	[terrain]
	x,y=56,90
	letter=D
	[/terrain]

	[terrain]
	x,y=55,98
	letter=D
	[/terrain]

	[terrain]
	x,y=59,89
	letter=D
	[/terrain]

	[terrain]
	x,y=61,95
	letter=D
	[/terrain]

	[terrain]
	x,y=65,94
	letter=D
	[/terrain]

	# there are two sets of villages in the tunnels around the great 
	# central cave. One set will be erased when the player chooses
	# a side. To avoid duplication, I should make one set manually, so
	# only one set is added to the early finish bonus
 
	# tunnel villages, troll side
	[terrain]
	x,y=25,64
	letter=D
	[/terrain]

	[terrain]
	x,y=33,63
	letter=D
	[/terrain]

	[terrain]
	x,y=32,67
	letter=D
	[/terrain]

	[terrain]
	x,y=46,62
	letter=D
	[/terrain]


# starting dialogue

[if]
	[have_unit]
	description=Elyssa
	[/have_unit]

	[then]

	[message]
	description=Kaleh
	message= _ "You mentioned that Dwarves and Trolls often lived underground Elyssa. I've only heard myths, have you every met a Dwarf or a Troll?"
	[/message]

	[message]
	description=Elyssa
	message= _ "No I haven't, I don't often explore underground unless I have to. There are lots of nasty things that lurk far away from the light of the suns. But I have read a bit about them, and have a even met a few people who have had dealings with Dwarves."

	[/message]

	[message]
	description=Nym
	message= _ "What are they like?"
	[/message]

	[message]
	description=Elyssa
	message= _ "They're a proud people, and some would say greedy. They love their gold and fine metals, and forge many beautiful things. I should warn you, they have little liking for Elves. There was some betrayal many years ago, though I don't know what happened."
	[/message]

	[message]
	description=Kaleh
	message= _ "And what about Trolls? I'm not sure I'd want to meet one face to face."
	[/message]

	[message]
	description=Elyssa
	message= _ "Trolls and Dwarves are natural enemies, living so close together. And many would say trolls are little more that brutes and savages. Trolls are huge and very strong, with skin as hard as stone, and can be a fearsome foes. But I knew one man long ago who traded with a group of trolls and said they were quite honorable, as long as you didn't try to cheat them."
	[/message]

	[message]
	description=Zhul
	message= _ "Well, with Eloh's guidance, I hope we find these tunnels deserted. I'd be happy if our biggest problem is not getting lost. I have little wish to meet either Dwarves or Trolls. But Eloh will watch over us."
	[/message]

	[message]
	description=Kaleh
	message= _ "Will she? I got the impression she was powerless underground."
	[/message]

	[message]
	description=Zhul
	message= _ "Where did you get that idea? Certainly Eloh is strongest during the day, when the suns are shining down on us. But it is said that even in the darkest of nights she will protect her faithful. And back during the Golden Age holy elven warriors led great crusades against orcs and other foul things that hid underground, killing them with Eloh's aid. Faith is our shield, Kaleh. I think you should keep your doubts to yourself, it would not do to unduly worry our people. Eloh will always protect us, if we follow her path. "
	[/message]

	[message]
	description=Kaleh
	message= _ "Then let us hope the rest of our journey may be as uneventful as it has been this far."
	[/message]

	[/then]

	[else]

	[message]
	description=Kaleh
	message= _ "I've heard of dwarves, but do you have any idea Zhul what kinds of creatures we might encounter underground?"
	[/message]

	[message]
	description=Zhul
	message= _ "These tunnels are forign to me, I know little more than you do. All I know about dwarves is from the few tales from the Golden Age."
	[/message]

	[message]
	description=Nym
	message= _ "What are they like?"
	[/message]

	[message]
	description=Zhul
	message= _ "They're lived deep under the earth, mining gold and fine metals and forging many beautiful things. We were once allies during the Golden Age, but in the strife and chaos of the fall we lost all contact. I don't know if any survived. But in the golden age they were very helpful in  our wars against the orcs and trolls."
	[/message]

	[message]
	description=Kaleh
	message= _ "What are trolls?"
	[/message]

	[message]
	description=Zhul
	message= _ "Trolls were huge green creatures as big as giants and very strong. They were reclusive creatures, hiding underground. We never had much contact with them, though some fought with the orcs in the great wars. They were mighty warriors. I'm sure they have all died off, I certainly would never want to meet one fact to face."
	[/message]

	[message]
	description=Zhul
	message= _ "But with Eloh's guidance, I hope we find these tunnels deserted. I'd be happy if our biggest problem is not getting lost. Still, even underground Eloh will watch over us."
	[/message]

	[message]
	description=Kaleh
	message= _ "Will she? I got the impression she was powerless underground."
	[/message]

	[message]
	description=Zhul
	message= _ "Where did you get that idea? Certainly Eloh is strongest during the day, when the suns are shining down on us. But it is said that even in the darkest of nights she will protect her faithful. And back during the Golden Age holy elven warriors led great crusades against orcs and other foul things that hid underground, killing them with Eloh's aid. Faith is our shield, Kaleh. I think you should keep your doubts to yourself, it would not do to unduly worry our people. Eloh will always protect us, if we follow her path. "
	[/message]

	[message]
	description=Kaleh
	message= _ "Then let us hope the rest of our journey may be as uneventful as it has been this far."
	[/message]
	
	[/else]
[/if]

[/event]


# Event 1: Spider and Ants

[event]
name=moveto

[filter]
x=12-18
y=47-56
side=1
[/filter]

[message]
description=Nym
message= _ "All I'm saying is that these tunnels aren't as bad as I expected."
[/message]

[message]
description=Kaleh
message= _ "Ssshhhh, did you hear something?"
[/message]

[remove_shroud]
	side=1
	x=11-19
	y=51-54
[/remove_shroud]

#make ants easy: 3 medium: 4 hard: 5

{UNIT_ (Giant Ant) () 8 17 53}
{UNIT_ (Giant Ant) () 8 17 54}
{UNIT_ (Giant Ant) () 8 18 53}

#ifdef EASY
#else
{UNIT_ (Giant Ant) () 8 18 54}
#endif

#ifdef HARD
{UNIT_ (Giant Ant) () 8 19 54}
#endif

#make spider 
{UNIT_ (Cave Spider) () 9 4 52}

[message]
description=Zhul
message= _ "Ants. Very big ants. Maybe they won't be hostile."
[/message]

[message]
description=Kaleh
message= _ "On the other hand, that spider probably is."
[/message]

[message]
description=Nym
message= _ "Caught between a spider and it's prey. Not a good place to be."
[/message]

[/event]

#if player escapes cave spider, then reward player by killing it 
[event]
name=moveto

[filter]
x=16-22
y=54-56
type=Cave Spider
[/filter]

[kill]
type=Cave Spider
animate=yes
[/kill]

{PUT_IMG terrain/rocks.png x1 y1}

[message]
description=Nym
message= _ "Woah! Did you see that? That huge stalactite just fell and crushed the spider. Aren't we lucky."
[/message]

[/event]

[event]
name=moveto

[filter]
x=18-24
y=53-56
side=1
[/filter]

[message]
description=Nym
message= _ "You know, if all we discover down here are insects, I'll be very disappointed. "
[/message]

[if]
	[have_unit]
	description=Elyssa
	[/have_unit]

	[then]

	[message]
	description=Elyssa
	message= _ "Spiders aren't insects."
	[/message]

	[message]
	description=Nym
	message= _ "Thanks for the clarification."
	[/message]

	[/then]
[/if]

[move_unit_fake]
type=Dwarvish Fighter
x=25,24,23,22,21
y=55,55,56,55,56
[/move_unit_fake]

{UNIT_ (Dwarvish Fighter) (Wounded Dwarf) 4 21 56}

[message]
description=Wounded Dwarf
message= _ "Help! They're everywhere!"
[/message]

[kill]
description=Wounded Dwarf
animate=yes
[/kill]

[message]
description=Kaleh
message= _ "Nym, your timing is impeccable."
[/message]

[if]
	[have_unit]
	description=Elyssa
	[/have_unit]

	[then]

	[message]
	description=Elyssa
	message= _ "That's a dwarf, but it looks like he's been beaten to a pulp."
	[/message]

	[/then]

	[else]

	[message]
	description=Zhul
	message= _ "Short and hairy, he must be a dwarf. But he's been beaten to a pulp."
	[/message]

	[/else]
[/if]

[message]
description=Kaleh
message= _ "I don't know that 'they' are, but we can't go back. Prepare yourselves for anything, everyone."
[/message]

[/event]


# EVENT 5 IS LISTED OUT OF ORDER BECAUSE FOR SOME REASON IT WASN'T
# FIRING WHEN PLACED AFTER EVENT 4.5. CURRENTLY THIS EVENT WORKS
# FINE WHEN IT IS HERE AND EVENT 6 FIRES FINE AFTER 4.5. SO EVEN
# THOUGH THE EVENTS ARE OUT OF ORDER, I'M LEAVING THEM THIS WAY
# BECAUSE IT SEEMS TO MAKE EVERYTHING WORK FINE.

# Event 5: Sighted dwarf/troll leader events

[event]
name=moveto

[filter]
x=20-28
y=34-42
side=1
[/filter]

[remove_shroud]
x=20-28
y=34-42
side=1
[/remove_shroud]

[if]
	[variable]
	name=elvish_ally
	numerical_equals=1
	[/variable]

	[then]

	[message]
	description=Fundin
	message= _ "What are you doing back here? The trolls hide in the southern tunnels, not this way."
	[/message]

	[/then]

	[else]

	# open other exit from cave, closed off to try to keep AI 
	# from guarding it
	[terrain]
	x,y=27,35
	letter=u
	[/terrain]

	[message]
	description=Fundin
	message= _ "Treacherous elves, how can you fight with such horrid creatures as Trolls. I will cleave all in two with my axe!"
	[/message]

	[/else]
[/if]
[/event] 

[event]
name=moveto

[filter]
x=41-50
y=34-40
side=1
[/filter]

[remove_shroud]
x=40-52
y=33-40
side=1
[/remove_shroud]

[if]
	[variable]
	name=elvish_ally
	numerical_equals=1
	[/variable]

	[then]

	[message]
	description=Nori
	message= _ "What are you doing back here? The trolls hide in the southern tunnels, not this way."
	[/message]

	[/then]

	[else]

	# open other exit from cave, closed off to try to keep AI 
	# from guarding it
	
	[terrain]
	x,y=44,33
	letter=u
	[/terrain]

	[message]
	description=Nori
	message= _ "Stupid elves, we are masters of fighting underground and we will die to defend our home. Fight on, my brothers!"
	[/message]

	[/else]
[/if]
[/event] 

[event]
name=moveto

[filter]
x=23-31
y=66-74
side=1
[/filter]

[remove_shroud]
x=21-32
y=67-74
side=1
[/remove_shroud]

[if]
	[variable]
	name=elvish_ally
	numerical_equals=1
	[/variable]

	[then]

	[message]
	description=Thungar
	message= _ "Nasty Dwarves and Stinkin' Elves, we will smash you all!"
	[/message]

	[/then]

	[else]

	[message]
	description=Thungar
	message= _ "What you doing back here? Nasty dwarves are to the north, no dwarves this way. Go back and fight bravely."
	[/message]
	
	[/else]
[/if]
[/event] 
 

[event]
name=moveto

[filter]
x=41-49
y=68-74
side=1
[/filter]

[remove_shroud]
x=41-51
y=67-74
side=1
[/remove_shroud]

[if]
	[variable]
	name=elvish_ally
	numerical_equals=1
	[/variable]

	[then]

	[message]
	description=Gnarl
	message= _ "Kill the elves! We must stop them here. This is our land, crush the intruders!"
	[/message]

	[/then]

	[else]

	[message]
	description=Gnarl
	message= _ "What you doing back here? Nasty dwarves are to the north, no dwarves this way. Go back and fight bravely."
	[/message]
	
	[/else]
[/if]
[/event] 



# Event 2: Entering the large cavern

#player chooses one side (trolls or dwarves) then:

#assign allies
#create troll and dwarf leaders
#create dwarf and troll defenders, make one side attackers
#change ally and enemy gold/income
#capture all villages, destroy ally's tunnel villages
#seal off exits from allies caves
#set battle turn counter

[event]
name=moveto

[filter]
x=24-74
y=47-61
side=1
[/filter]

#reveal large cave x: 25-47 y: 46-62
[remove_shroud]
	side=1
	x=25-47
	y=46-62
[/remove_shroud]

#create 14 dwarves and 12 trolls 

#dwarves:
# 2 dwarvish steelclads, 3 dwarvish fighters, 1 dwarvish thunderguard, 2 dwarvish thunderers, 1 dwarvish guardsman, 1 dwarvish stalwart, 1 dwarvish ulfserker, 1 dwarvish steelclad (captain), and 1 dwarvish pathfinder and 1 scout

#trolls:
# 6 troll whelps, 2 trolls, 2 troll rocklobbers, 1 shaman, 1 shaman leader

# on EASY and NORAML, reduce number of trolls and dwarves
# if EASY:
# Dwarves: 	remove 1 fighter (39,48), and 1 thunderer (35,47)
#		and 1 scout (34,53)
# Trolls: 	remove 2 troll whelps (37,59) (34,61)
#		turn troll rocklobber into a whelp (33,59)

# if NORMAL:
# Dwarves: 	remove 1 fighter (39,48)
# Trolls: 	remove 2 troll whelps (37,59) (34,61)


#Western side 
	#battling over the castle
	#1 dwarvish fighter, 1 dwarvish thunderer, 1 dwarvish guardsman

	{UNIT_T (Dwarvish Fighter) (Dwarf Defender) 4 30 54}
	{UNIT_T (Dwarvish Thunderer) (Dwarf Defender) 4 30 52}
	{UNIT_T (Dwarvish Guardsman) (Dwarf Defender) 4 29 57}

	#2 troll whelps
	{UNIT_T (Troll Whelp2) (Troll Defender) 3 31 57}
	{UNIT_T (Troll Whelp2) (Troll Defender) 2 29 55}

	#western reinforcements

	#1 dwarvish berserker, 1 dwarvish steelclad (captain), 1 dwarvish fighter, (added: 1 dwarvish scout)

	{UNIT_T (Dwarvish Ulfserker) (Dwarf Defender) 4 30 48}
	{UNIT_T (Dwarvish Steelclad) (Dwarf Leader) 4 32 47}
	{UNIT_T (Dwarvish Fighter) (Dwarf Defender) 5 34 49}
	#ifdef EASY
	#else
	{UNIT_T (Dwarvish Scout) (Dwarf Defender) 4 34 53}
	#endif
	
	#2 troll whelps, 1 troll rocklobber, 1 shaman (captain)
	
	{UNIT_T (Troll Whelp2) (Troll Defender) 2 29 58}
	
	#unit was originally a troll
	#ifdef HARD	
	{UNIT_T (Troll Whelp2) (Troll Defender) 2 34 61}
	#endif

	#ifdef EASY
	{UNIT_T (Troll Whelp2) (Troll Defender) 2 33 59}
	#else
	{UNIT_T (Troll Rocklobber2) (Troll Defender) 2 33 59}
	#endif

	{UNIT_T (Troll Shaman) (Troll Leader) 2 28 60}

#Center
	#1 dwarvish thunderer (N village)
	
	#ifdef EASY
	#else
	{UNIT_T (Dwarvish Thunderer) (Dwarf Defender) 5 35 47}
	#endif

#Eastern side
	#battling over the center
	
	#1 dwarvish steelclad, 1 dwarvish guardsman, 1 dwarvish thunderer
	# (added 1 dwarvish scout)
	{UNIT_T (Dwarvish Steelclad) (Dwarf Defender) 5 40 53}
	{UNIT_T (Dwarvish Guardsman) (Dwarf Defender) 5 39 51}
	{UNIT_T (Dwarvish Thunderer) (Dwarf Defender) 5 42 50}
	{UNIT_T (Dwarvish Scout) (Dwarf Defender) 5 44 53}
	
	#1 troll whelp, 1 troll, 1 troll rocklobber

	{UNIT_T (Troll Whelp2) (Troll Defender) 2 41 54}
	{UNIT_T (Troll2) (Troll Defender) 3 42 56}
	{UNIT_T (Troll Rocklobber2) (Troll Defender) 3 39 56}

	#eastern reinforcements

	#1 dwarvish steelclad, 1 dwarvish fighter

	{UNIT_T (Dwarvish Steelclad) (Dwarf Defender) 5 42 48}

	#ifdef HARD
	{UNIT_T (Dwarvish Fighter) (Dwarf Defender) 5 39 48}
	#endif
	
	#2 troll whelps, 1 shaman

	#ifdef HARD
	{UNIT_T (Troll Whelp2) (Troll Defender) 3 37 59}
	#endif
	{UNIT_T (Troll Whelp2) (Troll Defender) 3 42 59}
	{UNIT_T (Troll Shaman) (Troll Defender) 3 44 58}

[redraw]
[/redraw]

#dwarf/troll/elf dialogue

[message]
speaker=unit
message= _ "Woah."
[/message]

[scroll_to_unit]
x,y=34,49
[/scroll_to_unit]

[delay]
time=400
[/delay]

[scroll_to_unit]
x,y=42,50
[/scroll_to_unit]

[delay]
time=400
[/delay]

[scroll_to_unit]
x,y=42,56
[/scroll_to_unit]

[delay]
time=400
[/delay]

[scroll_to_unit]
x,y=33,59
[/scroll_to_unit]

[delay]
time=400
[/delay]

[scroll_to_unit]
x,y=29,54
[/scroll_to_unit]

[delay]
time=400
[/delay]

[message]
description=Nym
message= _ "I think I preferred the spider and the ants..."
[/message]

[message]
description=Dwarf Leader
message= _ "Stand firm boys, here they come!"
[/message]

[message]
description=Troll Leader
message= _ "You invade our tunnels, you slaughter our women and children, by Griknagh we will make you pay."
[/message]

[message]
description=Dwarf Leader
message= _ "Tenacious savages aren't they. But these tunnels are rich in ore, and we won't let a couple of trolls keep them from us. "
[/message]

[message]
description=Troll Leader
message= _ "Wait...What..Who are you?"
[/message]

[message]
description=Kaleh
message= _ "Uh...."
[/message]

[message]
description=Dwarf Leader
message= _ "What in Moradin's name are they?"
[/message]

[message]
x,y=29,54
message= _ "Wait a minute....blond hair, pointy ears, they must be Elves"
[/message]

[message]
x,y=30,52
message= _ "Elves? What is the nine hells are Elves doing down here?"
[/message]

[message]
description=Dwarf Leader
message= _ "Nevermind that, who are you?"
[/message]

[message]
description=Kaleh
message= _ "I am Kaleh, and we are the Quenoth elves. What in Eloh's name is going on here?"
[/message]

[message]
description=Troll Leader
message= _ "They invade our land and kill our young. Dwarves always want more, always greedy for glittery rocks."
[/message]

[message]
description=Dwarf Leader
message= _ "Those monsters killed me boys. Kaleh, if you be of stout heart, help us drive these lummoxes from our tunnels."
[/message]

[message]
description=Troll Leader
message= _ "No, this is our home. Help us, little ones, and we will help you."
[/message]

[message]
description=Zhul
message= _ "There's too many of them for us to try to take them both on, and besides with all these branching tunnels we'll have no idea which way to go. I think we should take them up on their offer; ally ourselves with one of the factions so we can get their help in finding a way back to the surface."
[/message]

[message]
description=Nym
message= _ "But even if we do, what about all of our people? How can we safely escort them through this war zone?"
[/message]

[message]
description=Kaleh
message= _ "We won't. If we keep the majority of our people hidden back up the passage we should be able to protect them, at least for a little while. In the meantime, we'll go ahead and try to sort out this mess. I think you're right Zhul, if we're lucky we may just be able to negotiate a safe passage out of here."
[/message]

#choose side to ally with

#set ally variable (1=dwarf 2=troll) and change elvish allegiance

[message]
speaker=unit
message= _ "But they both look evenly matched. Who should we ally with?"

	[option]
	message= _  "Let's aid the Dwarves."
	
	[command]
		[set_variable]
		name=elvish_ally
		value=1
		[/set_variable]
	[/command]
	
	[command]
		[modify_side]
		side=1
		team_name=dwarf
		[/modify_side]
	[/command]

	[command]
		[message]
		description=Troll Leader
		message= _ "Bah! Your kind all the same. Everyone turns on Trolls. But you'll see, Griknagh will smash you all."
		[/message]
	[/command]

	#set new scenario objectives
	
[command]
	[objectives] 
	summary= _ "New Objectives:"
	show=yes 
		[objective] 
			description= _ "Defeat Troll Leaders" 	
			condition=win 	
		[/objective] 
		[objective] 
			description= _ "Death of Kaleh, Nym or Zhul" 
			condition=lose 
		[/objective] 
	[/objectives]
[/command]

	[/option]

	[option]
	message= _  "Let's aid the Trolls."

	[command]
		[set_variable]
		name=elvish_ally
		value=2
		[/set_variable]
	[/command]

	[command]
		[modify_side]
		side=1
		team_name=troll
		[/modify_side]
	[/command]

	[command]
		[message]
		description=Dwarf Leader
		message= _ "I knew elves couldn't be trusted. Foolish boy, you will regret your betrayal. Taste dwarven steel!"
		[/message]
	[/command]

	#set new scenario objectives
[command]
	[objectives] 
	summary= _ "New Objectives:"
	show=yes 
		[objective] 
			description= _ "Defeat Dwarf Leaders" 	
			condition=win 	
		[/objective] 
		[objective] 
			description= _ "Death of Kaleh, Nym or Zhul" 
			condition=lose 
		[/objective] 
	[/objectives]
[/command]

	[/option]
[/message]

[message]
speaker=unit
message= _ "There seems to be an abandoned Dwarvish fortress right in front of us. If we can fight our way to the keep, we should be able to start rallying our warriors to help in the battle."
[/message]

#add enemy units in tunnels who will arrive in main cavern at turn 2

[if]
	[variable]
	name=elvish_ally
	numerical_equals=1
	[/variable]

	[then]
	
	# EASY: add 2 trolls, MED: add 2 trolls HARD: add 3 trolls
	# (on easier difficulties, remove trolls closest to elves)

	#ifdef HARD
	{UNIT_T (Troll Whelp2) (Troll Skirmisher) 2 25 64}
	#endif

	{UNIT_T (Troll Whelp2) (Troll Skirmisher) 3 33 66}
	
	{UNIT_T (Troll Whelp2) (Troll Skirmisher) 3 46 62}
	
	[/then]

	[else]

	#add 3-4 dwarf enemies
	# if EASY difficulty, then remove berserker and fighter
	
	#ifdef EASY
	#else
	# (was a dwarvish steelclad)
	{UNIT_T (Dwarvish Fighter) (Dwarf Skirmisher) 4 26 45}
	#endif

	# (was a dwarvish pathfinder)
	{UNIT_T (Dwarvish Scout) (Dwarf Skirmisher) 4 28 45}

	#ifdef MEDIUM
	{UNIT_T (Dwarvish Ulfserker) (Dwarf Skirmisher) 5 38 44}
	#endif

	#ifdef HARD
	{UNIT_T (Dwarvish Berserker) (Dwarf Skirmisher) 5 38 44}
	#endif

	{UNIT_T (Dwarvish Scout) (Dwarf Skirmisher) 5 43 45}
	
	[/else]
[/if]

#increase recruitment options for enemies
#set gold/income for allies and enemies

# I think the trolls are slightly more powerful than the dwarves
# So I'm giving trolls 2 less income than dwarves

[if]
	[variable]
	name=elvish_ally
	numerical_equals=1
	[/variable]

	[then]
	#ally with dwarves
		
	[allow_recruit]
		type=Troll Shaman
		side=2
	[/allow_recruit]

	[allow_recruit]
		type=Troll Shaman
		side=3
	[/allow_recruit]

	#allies
	[modify_side]
		side=4
		
		#ifdef EASY
		income=2
		gold=50
		#endif
		#ifdef MEDIUM
		income=0
		gold=50
		#endif
		#ifdef HARD
		income=0
		gold=25
		#endif
	[/modify_side]

	[modify_side]
		side=5
		
		#ifdef EASY
		income=2
		gold=50
		#endif
		#ifdef MEDIUM
		income=0
		gold=50
		#endif
		#ifdef HARD
		income=0
		gold=25
		#endif
	[/modify_side]

	#enemies
	[modify_side]
		side=2
		
		#ifdef EASY
		income=0
		gold=100
		#endif
		#ifdef MEDIUM
		income=3
		gold=125
		#endif
		#ifdef HARD
		income=5
		gold=150
		#endif
	[/modify_side]

	[modify_side]
		side=3
		
		#ifdef EASY
		income=0
		gold=100
		#endif
		#ifdef MEDIUM
		income=3
		gold=125
		#endif
		#ifdef HARD
		income=5
		gold=150
		#endif
	[/modify_side]
	
	[/then]

	[else]
	#ally with trolls

	#ulfserkers are too deadly, especially for elves with no defense

	[allow_recruit]
		type=Dwarvish Pathfinder
		side=4
	[/allow_recruit]

	[allow_recruit]
		type=Dwarvish Pathfinder
		side=5
	[/allow_recruit]

	#allies
	[modify_side]
		side=2
		
		#ifdef EASY
		income=2
		gold=50
		#endif
		#ifdef MEDIUM
		income=0
		gold=50
		#endif
		#ifdef HARD
		income=0
		gold=25
		#endif
	[/modify_side]

	[modify_side]
		side=3
		
		#ifdef EASY
		income=2
		gold=50
		#endif
		#ifdef MEDIUM
		income=0
		gold=50
		#endif
		#ifdef HARD
		income=0
		gold=25
		#endif
	[/modify_side]

	#enemies
	[modify_side]
		side=4
		
		#ifdef EASY
		income=4
		gold=125
		#endif
		#ifdef MEDIUM
		income=6
		gold=150
		#endif
		#ifdef HARD
		income=8
		gold=150
		#endif
	[/modify_side]

	[modify_side]
		side=5
		
		#ifdef EASY
		income=4
		gold=125
		#endif
		#ifdef MEDIUM
		income=6
		gold=150
		#endif
		#ifdef HARD
		income=8
		gold=150
		#endif
	[/modify_side]

	[/else]
[/if]


#create 2 dwarf leaders (30,37) (51,37)
[unit]
	type=Dwarvish Explorer
	description=Fundin
	canrecruit=1
	upkeep=free
	x=23
	y=38
	side=4
	[modifications]
	{TRAIT_LOYAL}
	{TRAIT_RESILIENT}
	[/modifications]
[/unit]

[unit]
	type=Dwarvish Explorer
	description=Nori
	canrecruit=1
	upkeep=full
	x=45
	y=37
	side=5
	[modifications]
	{TRAIT_STRONG}
	{TRAIT_QUICK}
	[/modifications]
[/unit]

#create 2 troll leaders (32,70) (52,72)
[unit]
	type=Troll Warrior2
	description=Thungar
	canrecruit=1
	upkeep=free
	x=26
	y=70
	side=2
	[modifications]
	{TRAIT_LOYAL}
	{TRAIT_RESILIENT}
	[/modifications]
[/unit]

[unit]
	type=Troll Warrior2
	description=Gnarl
	canrecruit=1
	upkeep=full
	x=46
	y=72
	side=3
	[modifications]
	{TRAIT_STRONG}
	{TRAIT_QUICK}
	[/modifications]
[/unit]

[set_variable]
name=number_enemies
value=12
[/set_variable]

#change description of units on enemy side

[set_variable]
name=i
value=$number_enemies
[/set_variable]

{LOOP i}

[if]
	[variable]
	name=elvish_ally
	numerical_equals=2
	[/variable]

	[then]

	[store_unit]
		[filter]
		description=Dwarf Defender
		[/filter]
	variable=unitstats
	[/store_unit]

	[set_variable]
		name=unitstats.description
		value=Dwarf Skirmisher
	[/set_variable]

	[set_variable]
		name=unitstats.user_description
		value=Dwarf Skirmisher
	[/set_variable]

	[unstore_unit]
		variable=unitstats
	[/unstore_unit]

	{CLEAR_VARIABLE unitstats}
	
	[/then]

	[else]

	[store_unit]
		[filter]
		description=Troll Defender
		[/filter]
	variable=unitstats
	[/store_unit]

	[set_variable]
		name=unitstats.description
		value=Troll Skirmisher
	[/set_variable]

	[set_variable]
		name=unitstats.user_description
		value=Troll Skirmisher
	[/set_variable]

	[unstore_unit]
		variable=unitstats
	[/unstore_unit]

	{CLEAR_VARIABLE unitstats}

	[/else]

[/if]

{CLEAR_VARIABLE unitstats}

{NEXT i}


#destroy ally's villages in the tunnels
[if]
	[variable]
	name=elvish_ally
	numerical_equals=1
	[/variable]

	[then]
	#if allied with dwarves
	#destroy dwarvish villages in tunnels

	[terrain]
	x=25,33,40,35
	y=46,37,44,47
	letter=u
	[/terrain]

	[/then]

	[else]
	#if allied with trolls
	#destroy troll villages in tunnels

	[terrain]
	x=25,33,32,46
	y=64,63,67,62
	letter=u
	[/terrain]

	[/else]
[/if]

#destroy allies easter egg and final lair villages

[if]
	[variable]
	name=elvish_ally
	numerical_equals=1
	[/variable]

	[then]
	#if allied with dwarves

	[terrain]
	x=22,24,25,30,27
	y=11,14,19,16,10
	letter=u
	[/terrain]

	#easter egg
	[terrain]
	x,y=38,5
	letter=u
	[/terrain]

	[/then]

	[else]
	#if allied with trolls

	[terrain]
	x=56,59,55,61,65
	y=90,89,98,95,94
	letter=u
	[/terrain]

	#easter egg village
	[terrain]
	x,y=25,94
	letter=u
	[/terrain]

	[/else]
[/if]


#capture villages for each troll/dwarf leader

#troll 1 (side2)

#in troll cave
[capture_village]
x,y=23,69
side=2
[/capture_village]

[capture_village]
x,y=23,72
side=2
[/capture_village]

[capture_village]
x,y=26,73
side=2
[/capture_village]

[capture_village]
x,y=30,72
side=2
[/capture_village]

#in tunnels
[capture_village]
x,y=25,64
side=2
[/capture_village]

[capture_village]
x,y=32,67
side=2
[/capture_village]

#in main cavern
[capture_village]
x,y=31,57
side=2
[/capture_village]

#troll 2 (side3)

#in troll cave
[capture_village]
x,y=41,69
side=3
[/capture_village]

[capture_village]
x,y=50,68
side=3
[/capture_village]

[capture_village]
x,y=43,73
side=3
[/capture_village]

[capture_village]
x,y=48,74
side=3
[/capture_village]

#in tunnels
[capture_village]
x,y=33,63
side=3
[/capture_village]

[capture_village]
x,y=46,62
side=3
[/capture_village]

#in main cavern
[capture_village]
x,y=36,59
side=3
[/capture_village]

[capture_village]
x,y=40,53
side=3
[/capture_village]


#dwarf 1 (side4)

#in dwarf cave
[capture_village]
x,y=21,36
side=4
[/capture_village]

[capture_village]
x,y=25,34
side=4
[/capture_village]

[capture_village]
x,y=25,40
side=4
[/capture_village]

[capture_village]
x,y=27,38
side=4
[/capture_village]


#in tunnels
[capture_village]
x,y=25,46
side=4
[/capture_village]

[capture_village]
x,y=33,37
side=4
[/capture_village]

#in main cavern
[capture_village]
x,y=28,51
side=4
[/capture_village]


#dwarf 2 (side5)

#in dwarf cave
[capture_village]
x,y=47,34
side=5
[/capture_village]

[capture_village]
x,y=43,39
side=5
[/capture_village]

[capture_village]
x,y=48,36
side=5
[/capture_village]

[capture_village]
x,y=51,37
side=5
[/capture_village]


#in tunnels
[capture_village]
x,y=40,44
side=5
[/capture_village]

[capture_village]
x,y=35,47
side=5
[/capture_village]

#in main cavern
[capture_village]
x,y=35,54
side=5
[/capture_village]


#seal off exits from ally's caves

[if]
	[variable]
	name=elvish_ally
	numerical_equals=1
	[/variable]

	[then]
	#if allied with dwarves

	[terrain]
	x,y=44,33
	letter=W
	[/terrain]

	[terrain]
	x,y=27,35
	letter=W
	[/terrain]

	[terrain]
	x,y=19,40
	letter=W
	[/terrain]

	[terrain]
	x,y=22,34
	letter=W
	[/terrain]
	
	[/then]

	[else]
	#if allied with trolls

	[terrain]
	x,y=25,75
	letter=W
	[/terrain]

	[terrain]
	x,y=46,76
	letter=W
	[/terrain]

	[/else]
[/if]

[set_variable]
name=battle_turn_counter
value=1
[/set_variable]

[/event]


# Event 3: Enemy counter-attack (Battle Turn 4)

# if fighting dwarves: (3,4,5)
# run 2 dwarvish thunderguards down to western threatre, 
# and 1 down to eastern bottleneck

# if fighting trolls: (3,4,5)
# run 2 troll shamans up to western threatre, and 1 up to eastern
# bottleneck (reduced to 1 on each side)

# they destroy (Easy:33%  Medium: 50% Hard: 50%) of your allies


#define ENEMY_ATTACK

	[if]
		[variable]
		name=elvish_ally
		numerical_equals=1
		[/variable]

		[then]
		#if allied with dwarves

		#west side

		[move_unit_fake]
		type=Troll Shaman
		x=22,23,24,25,26,27,27,27,28
		y=64,64,63,63,62,62,61,60,59
		[/move_unit_fake]

		{UNIT_T (Troll Shaman) (Troll Flamecaster) 2 28 59}

		#[move_unit_fake]
		#type=Troll Shaman
		#x=26,26,26,26,26,27,27,28,29,30
		#y=66,65,64,63,62,62,61,60,60,59
		#[/move_unit_fake]

		#{UNIT_T (Troll Shaman) (Troll Flamecaster) 2 30 59}

		#ifdef HARD

		[move_unit_fake]
		type=Troll Shaman
		x=32,33,34,34,34,34,33,32,31,30
		y=65,65,64,63,62,61,61,60,60,59
		[/move_unit_fake]

		{UNIT_T (Troll Shaman) (Troll Flamecaster) 2 32 59}
		#endif
	
		#east side

		[move_unit_fake]
		type=Troll Shaman
		x=47,47,47,46,45,44,43,42,42,42,42,41
		y=64,63,62,61,61,60,60,59,58,57,56,56
		[/move_unit_fake]

		{UNIT_T (Troll Shaman) (Troll Flamecaster) 3 41 56}
		#{UNIT_T (Troll Shaman) (Troll Flamecaster) 3 39 56}

		#ifdef EASY
		#else

		[move_unit_fake]
		type=Troll Shaman
		x=47,47,47,46,45,44,43,43,43,43,43
		y=64,63,62,61,61,60,60,59,58,57,56
		[/move_unit_fake]	

		{UNIT_T (Troll Shaman) (Troll Flamecaster) 3 43 56}
		#endif

		[message]
		description=Troll Flamecaster
		message= _ "Burn, Burn and Die!"
		[/message]

		[colour_adjust]
		red,green,blue=255,0,0
		[/colour_adjust]

		[redraw]
		[/redraw]

		[delay]
		time=100
		[/delay]

		[colour_adjust]
		red,green,blue=0,0,0
		[/colour_adjust]

		[redraw]
		[/redraw]

		[message]
		description=Dwarf Leader
		message= _ "Dive for cover!"
		[/message]

		[message]
		description=Kaleh
		message= _ "Those new troll shamans are decimating the dwarves with blasts of fire! This doesn't look good."
		[/message] 

		#store dwarves in main cave in array
		#main cave = x 32-51 y 48-60
		#store length of array as X
		#divide X in half = Y
		#loop Y times:
		#	(store dwarves in main cave in array)
		#	(store length of array as Z)
		#	(Random 0 to Z-1)
		#	(Kill random dwarf)
		# 	[set_variable]
		#	name=kill_x
		#	to_variable=locs[$i].x
		#	[/set_variable]
		#
		#	[set_variable]
		#	name=kill_y
		#	to_variable=locs[$i].y
		#	[/set_variable]

		[store_locations]
			x=24-46
			y=46-62
			[filter]
			description="Dwarf Defender"
			[/filter]
			variable=dwarf_list
		[/store_locations]

		[set_variable]
		name=number_of_dwarves
		value=$dwarf_list.length
		[/set_variable]
 
		[set_variable]
		name=number_to_kill
		value=$number_of_dwarves
		[/set_variable]

		#if easy kill 50%
		#if medium kill 60%
		#if hard kill 75%

		#ifdef EASY
		[set_variable]
		name=number_to_kill
		multiply=0.49
		[/set_variable]
		#endif

		#ifdef MEDIUM
		[set_variable]
		name=number_to_kill
		multiply=0.59
		[/set_variable]
		#endif

		#ifdef HARD
		[set_variable]
		name=number_to_kill
		multiply=0.74
		[/set_variable]
		#endif

		[set_variable]
		name=i
		value=$number_to_kill
		[/set_variable]
		
		{LOOP i}

			[store_locations]
			x=24-46
			y=46-62
			[filter]
			description="Dwarf Defender"
			[/filter]
			variable=dwarf_victims
			[/store_locations]

			[set_variable]
			name=number_of_victims
			value=$dwarf_victims.length
			[/set_variable]

			#subtract 1 because arrays go from 0 to length-1
			[set_variable]
			name=number_of_victims
			add=-1
			[/set_variable]

			[set_variable]
			name=random_string
			format=0..$number_of_victims
			[/set_variable]

			[set_variable]
			name=death
			random=$random_string
			[/set_variable]

			[set_variable]
			name=kill_x
			to_variable=dwarf_victims[$death].x
			[/set_variable]
		
			[set_variable]
			name=kill_y
			to_variable=dwarf_victims[$death].y
			[/set_variable]

			#have some dwarves scream as they die

			[if]
				[variable]
				name=i
				numerical_equals=-1
				[/variable]
			
				[then]
					
				[message]
				x,y=$kill_x,$kill_y
				message= _ "Aaauuuggghhhh!"
				[/message]

				[/then]
			[/if]

			[if]
				[variable]
				name=i
				numerical_equals=-3
				[/variable]
			
				[then]
					
				[message]
				x,y=$kill_x,$kill_y
				message= _ "No!!!"
				[/message]

				[/then]
			[/if]

			[if]
				[variable]
				name=i
				numerical_equals=-5
				[/variable]
			
				[then]
					
				[message]
				x,y=$kill_x,$kill_y
				message= _ "Help Me!!!"
				[/message]

				[/then]
			[/if]

			[kill]
			x,y=$kill_x,$kill_y
			animate=yes
			fire_event=no
			[/kill]

		{NEXT i}

		[message]
		description=Dwarf Leader
		message= _ "More accursed troll magic. Fall Back! "
		[/message]

		[message]
		description=Dwarf Leader
		message= _ "I need to go back and rally more reinforcements. We're hurtin' Kaleh, I'll need your men to cover for us. Do you best boy, and may Moradin watch over you."
		[/message]

		[kill]
		description=Dwarf Leader
		animate=no
		[/kill]

		[/then]

		[else]
		#if allied with trolls

		#west side
		[move_unit_fake]
		type=Dwarvish Thunderguard
		x=26,27,28,29,30,30,30
		y=45,46,46,47,47,48,49
		[/move_unit_fake]

		{UNIT_T (Dwarvish Thunderguard) (Dwarf Grenadier) 4 30 49}
		
		[move_unit_fake]
		type=Dwarvish Thunderguard
		x=26,27,28,29,30,31,32,32
		y=45,46,46,47,47,48,48,49
		[/move_unit_fake]

		{UNIT_T (Dwarvish Thunderguard) (Dwarf Grenadier) 4 32 49}

		#ifdef HARD

		[move_unit_fake]
		type=Dwarvish Thunderguard
		x=26,27,28,29,30,31,32,33,34
		y=45,46,46,47,47,48,48,49,49
		[/move_unit_fake]

		{UNIT_T (Dwarvish Thunderguard) (Dwarf Grenadier) 4 34 49}
		#endif
	
		#east side

		[move_unit_fake]
		type=Dwarvish Thunderguard
		x=44,43,43,42,41,41,40
		y=44,45,46,47,48,49,49
		[/move_unit_fake]

		{UNIT_T (Dwarvish Thunderguard) (Dwarf Grenadier) 5 40 49}
		
		#{UNIT_T (Dwarvish Thunderguard) (Dwarf Grenadier) 5 38 48}

		#ifdef EASY
		#else

		[move_unit_fake]
		type=Dwarvish Thunderguard
		x=44,43,43,42,42
		y=44,45,46,47,48
		[/move_unit_fake]

		{UNIT_T (Dwarvish Thunderguard) (Dwarf Grenadier) 5 42 48}
		#endif
		
		[message]
		description=Dwarf Grenadier
		message= _ "Let's blast those monsters back to the pits they spawned from! Fire in the hole!"
		[/message]

		[colour_adjust]
		red,green,blue=255,0,0
		[/colour_adjust]

		[redraw]
		[/redraw]

		[delay]
		time=100
		[/delay]

		[colour_adjust]
		red,green,blue=0,0,0
		[/colour_adjust]

		[redraw]
		[/redraw]

		[message]
		description=Troll Leader
		message= _ "More Dwarven trickery! Fall Back!"
		[/message]

		[message]
		description=Kaleh
		message= _ "Those new dwarves are lobbing explosives at the trolls with devastating effect! I don't think the trolls can take this much longer."
		[/message]

		[store_locations]
			x=24-46
			y=46-62
			[filter]
			description="Troll Defender"
			[/filter]
			variable=troll_list
		[/store_locations]

		[set_variable]
		name=number_of_trolls
		value=$troll_list.length
		[/set_variable]
 
		[set_variable]
		name=number_to_kill
		value=$number_of_trolls
		[/set_variable]

		#if easy kill 50%
		#if medium kill 60%
		#if hard kill 75%

		#ifdef EASY
		[set_variable]
		name=number_to_kill
		multiply=0.49
		[/set_variable]
		#endif

		#ifdef MEDIUM
		[set_variable]
		name=number_to_kill
		multiply=0.59
		[/set_variable]
		#endif

		#ifdef HARD
		[set_variable]
		name=number_to_kill
		multiply=0.74
		[/set_variable]
		#endif

		[set_variable]
		name=i
		value=$number_to_kill
		[/set_variable]
		
		{LOOP i}

			[store_locations]
			x=24-46
			y=46-62
			[filter]
			description="Troll Defender"
			[/filter]
			variable=troll_victims
			[/store_locations]

			[set_variable]
			name=number_of_victims
			value=$troll_victims.length
			[/set_variable]

			#subtract 1 because arrays go from 0 to length-1
			[set_variable]
			name=number_of_victims
			add=-1
			[/set_variable]

			[set_variable]
			name=random_string
			format=0..$number_of_victims
			[/set_variable]

			[set_variable]
			name=death
			random=$random_string
			[/set_variable]

			[set_variable]
			name=kill_x
			to_variable=troll_victims[$death].x
			[/set_variable]
		
			[set_variable]
			name=kill_y
			to_variable=troll_victims[$death].y
			[/set_variable]

			#have some trolls scream as they die

			[if]
				[variable]
				name=i
				numerical_equals=-1
				[/variable]
			
				[then]
					
				[message]
				x,y=$kill_x,$kill_y
				message= _ "Aaauuuggghhhh!"
				[/message]

				[/then]
			[/if]

			[if]
				[variable]
				name=i
				numerical_equals=-3
				[/variable]
			
				[then]
					
				[message]
				x,y=$kill_x,$kill_y
				message= _ "No!!!"
				[/message]

				[/then]
			[/if]

			[if]
				[variable]
				name=i
				numerical_equals=-5
				[/variable]
			
				[then]
					
				[message]
				x,y=$kill_x,$kill_y
				message= _ "Gaggghhh!"
				[/message]

				[/then]
			[/if]

			[kill]
			x,y=$kill_x,$kill_y
			animate=yes
			fire_event=no
			[/kill]

		{NEXT i}
		
		[message]
		description=Troll Leader
		message= _ "I must go back and find more trolls to fight. You must hold them back Kaleh. Be strong like rock. Griknagh will be with you."
		[/message]
		
		[kill]
		description=Troll Leader
		animate=no
		[/kill]

		[/else]
	[/if]	

#enddef

# Event 4: Ally reinforcements
#	message: ally leader sent us to help you

#define ALLY_REINFORCEMENTS

	[if]

		[variable]
		name=elvish_ally
		numerical_equals=2
		[/variable]

		[then]

		# Troll
		# Easy: 3 whelps 1 troll shaman, 1 rock lobber
		# Medium: 3 whelps 1 troll shaman, 1 rock lobber
		# Hard: 2 whelps 1 troll shaman, 1 rock lobber

		[unit]
			type=Troll Shaman
			description=Thu'lok
			x=34
			y=59
			side=1
			[modifications]
				{TRAIT_LOYAL}
				{TRAIT_RESILIENT}
			[/modifications] 
		[/unit]

		[unit]
			type=Troll Whelp2
			description=Harpo
			x=33
			y=60
			side=1
			[modifications]
				{TRAIT_LOYAL}
				{TRAIT_STRONG}
			[/modifications] 
		[/unit]

		[unit]
			type=Troll Whelp2
			description=Groucho
			x=34
			y=60
			side=1
			[modifications]
				{TRAIT_LOYAL}
				{TRAIT_INTELLIGENT}
			[/modifications]
		[/unit]

		#ifdef HARD
		#else
		[unit]
			type=Troll Whelp2
			description=Chico
			x=35
			y=60
			side=1
			[modifications]
				{TRAIT_LOYAL}
				{TRAIT_RESILIENT}
			[/modifications] 
		[/unit]
		#endif
		
		[unit]
			type=Troll Rocklobber2
			description=Groo
			x=33
			y=61
			side=1
			[modifications]
				{TRAIT_LOYAL}
				{TRAIT_QUICK}
			[/modifications] 
		[/unit]

		[role]
		role=ally
		type=Troll Whelp2
		[/role]

		[role]
		role=ally
		type=Troll Rocklobber2
		[/role]

		[role]
		role=ally
		type=Troll Shaman
		[/role]

		[message]
		description=Thu'lok
		message= _ "Our leader sent us to help you. We fight for you until all the dwarves are dead. We will avenge the deaths of our people!"
		[/message]

		[/then]
		
		[else]

		# Dwarves
		# Easy: 2 dwarvish fighters, 1 thunderer, 1 berserker,
		# 1 dwarvish scout
		# Medium: 2 dwarvish fighters, 1 thunderer, 1 berserker,
		# 1 dwarvish scout
		# Hard: 1 dwarvish fighter, 1 thunderer, 1 berserker,
		# 1 dwarvish scout

		[unit]
			type=Dwarvish Fighter2
			description=Dwalim
			x=36
			y=48
			side=1
			[modifications]
				{TRAIT_LOYAL}
				{TRAIT_STRONG}
			[/modifications]
		[/unit]

		[unit]
			type=Dwarvish Pathfinder
			description=Moin
			x=35
			y=48
			side=1
			[modifications]
				{TRAIT_LOYAL}
				{TRAIT_QUICK}
			[/modifications]
		[/unit]

		[unit]
			type=Dwarvish Thunderer2
			description=Nordi
			x=37
			y=48
			side=1
			[modifications]
				{TRAIT_LOYAL}
				{TRAIT_INTELLIGENT}
			[/modifications]
		[/unit]

		[unit]
			type=Dwarvish Berserker2
			description=Byorn
			x=38
			y=47
			side=1
			[modifications]
				{TRAIT_LOYAL}
				{TRAIT_RESILIENT}
			[/modifications]
		[/unit]

		#ifdef HARD
		#else

		[unit]
			type=Dwarvish Fighter2
			description=Runin
			x=36
			y=47
			side=1
			[modifications]
				{TRAIT_LOYAL}
				{TRAIT_QUICK}
			[/modifications]
		[/unit]

		[role]
		role=ally
		type=Dwarvish Fighter2
		[/role]
		#endif

		[role]
		role=ally
		type=Dwarvish Fighter2
		[/role]

		[role]
		role=ally
		type=Dwarvish Berserker2
		[/role]

		[role]
		role=ally
		type=Dwarvish Thunderer2
		[/role]

		[role]
		role=ally
		type=Dwarvish Pathfinder
		[/role]

		[message]
		description=Dwalim
		message= _ "Looks like we came just in time. Our chief told us we're to fight with you until all the trolls are dead. Tell us where to go, I want to kill me some troll!"
		[/message]
		
		[/else]
	[/if]

#enddef

# Battle Turn Counter
# Each turn increment counter, to keep track of when battle
# events should happen

# also at start of each turn, erase gold/income for sides that are dead
# or who haven't been activated yet

[event]
name=new turn
first_time_only=no

[if]
	[variable]
	name=battle_turn_counter
	greater_than=0
	[/variable]

	[then]

	[set_variable]
	name=battle_turn_counter
	add=1
	[/set_variable]

	[/then]
[/if]

[if]
	[variable]
	name=battle_turn_counter
	numerical_equals=5
	[/variable]

	[then]

	{ENEMY_ATTACK}

	[/then]
[/if]

[if]
	[variable]
	name=battle_turn_counter
	numerical_equals=7
	[/variable]

	[then]

	{ALLY_REINFORCEMENTS}

	[/then]
[/if]

# at a random time later, the assassin should appear and challenge Kaleh

[if]
	[variable]
	name=battle_turn_counter
	numerical_equals=$assassin_turn
	[/variable]

	[then]

	[set_variable]
	name=call_assassin
	value=1
	[/set_variable]

	[/then]
[/if]

#once both dwarf/troll leaders are dead, cut off ally gold

[if]
	[variable]
	name=dead_dwarf_leaders
	numerical_equals=2
	[/variable]

	[then]
	
	[modify_side]
		side=2
		income=0
		gold=0
	[/modify_side]

	[modify_side]
		side=3
		income=0
		gold=0
	[/modify_side]

	[/then]
[/if]

[if]
	[variable]
	name=dead_troll_leaders
	numerical_equals=2
	[/variable]

	[then]
	
	[modify_side]
		side=4
		income=0
		gold=0
	[/modify_side]

	[modify_side]
		side=5
		income=0
		gold=0
	[/modify_side]

	[/then]
[/if]

#before you have tripped the bats event, keep them from gaining any gold

[if]
	[variable]
	name=tripped_bats
	numerical_equals=0
	[/variable]

	[then]
	
	[modify_side]
		side=8
		income=0
		gold=0
	[/modify_side]

	[/then]
[/if]

#before you have gotten close to dwarf lair, keep them from gaining any gold

[if]
	[variable]
	name=entered_dwarf_lair
	numerical_equals=0
	[/variable]

	[then]
	
	[modify_side]
		side=6
		income=0
		gold=0
	[/modify_side]

	[/then]
[/if]

#before you have gotten close to troll lair, keep them from gaining any gold

[if]
	[variable]
	name=entered_troll_lair
	numerical_equals=0
	[/variable]

	[then]
	
	[modify_side]
		side=7
		income=0
		gold=0
	[/modify_side]

	[/then]
[/if]

[/event]


# Event 4.5: when player moves onto dwarf cairn or troll totems, 
# his ally comments about it

#troll totems
[event]
name=moveto
first_time_only=no

[filter]
x=27,35,43
y=60,61,60
side=1
[/filter]
 
[if]
	[variable]
	name=elvish_ally
	numerical_equals=1
	[/variable]

	[variable]
	name=saw_cairn_or_totem
	numerical_equals=0
	[/variable]

	[have_unit]
	role=ally
	[/have_unit]

	[then]

	[set_variable]
	name=saw_cairn_or_totem
	value=1
	[/set_variable]

	[message]
	role=ally
	message= _ "The trolls display the skulls of their enemies as a way of marking their territory. How barbaric."
	[/message]

	[/then]
[/if]
[/event]

#dwarf cairns
[event]
name=moveto
first_time_only=no

[filter]
x=30,38,42
y=47,47,48
side=1
[/filter]
 
[if]
	[variable]
	name=elvish_ally
	numerical_equals=2
	[/variable]

	[variable]
	name=saw_cairn_or_totem
	numerical_equals=0
	[/variable]

	[have_unit]
	role=ally
	[/have_unit]

	[then]

	[set_variable]
	name=saw_cairn_or_totem
	value=1
	[/set_variable]

	[message]
	role=ally
	message= _ "The dwarves use stone cairns to make their territory. What a waste of good throwing stones."
	[/message]

	[/then]
[/if]
[/event]


# Event 6: death events for each leader

#for each death check to see if other leader is dead, if so
#cut off ally gold, remove ally village and ally units
#also send in dwarf/troll messenger telling player to fight on alone...

#cut off troll ally's income and gold, and remove allied troll villages

#define DWARVES_DEAD

[modify_side]
	side=2
	income=0
	gold=0
[/modify_side]

[modify_side]
	side=3
	income=0
	gold=0
[/modify_side]

#troll 1 (side2)
[capture_village]
x,y=23,69
side=9
[/capture_village]

[capture_village]
x,y=23,72
side=9
[/capture_village]

[capture_village]
x,y=26,73
side=9
[/capture_village]

[capture_village]
x,y=30,72
side=9
[/capture_village]

#troll 2 (side3)
[capture_village]
x,y=41,69
side=9
[/capture_village]

[capture_village]
x,y=50,68
side=9
[/capture_village]

[capture_village]
x,y=43,73
side=9
[/capture_village]

[capture_village]
x,y=48,74
side=9
[/capture_village]

[terrain]
x=23,23,26,30,41,50,43,48
y=69,72,73,72,69,68,73,74
letter=u
[/terrain]

[kill]
side=2
animate=no
[/kill]

[kill]
side=3
animate=no
[/kill]

#enddef

#cut off dwarf ally's income and gold, and remove allied dwarf villages

#define TROLLS_DEAD

[modify_side]
	side=4
	income=0
	gold=0
[/modify_side]

[modify_side]
	side=5
	income=0
	gold=0
[/modify_side]

#dwarf 1 (side4)
[capture_village]
x,y=21,36
side=9
[/capture_village]

[capture_village]
x,y=25,34
side=9
[/capture_village]

[capture_village]
x,y=25,40
side=9
[/capture_village]

[capture_village]
x,y=27,38
side=9
[/capture_village]


#dwarf 2 (side5)
[capture_village]
x,y=47,34
side=9
[/capture_village]

[capture_village]
x,y=43,39
side=9
[/capture_village]

[capture_village]
x,y=48,36
side=9
[/capture_village]

[capture_village]
x,y=51,37
side=9
[/capture_village]

[terrain]
x=21,25,25,27,47,43,48,51
y=36,34,40,38,34,39,36,37
letter=u
[/terrain]

[kill]
side=4
animate=no
[/kill]

[kill]
side=5
animate=no
[/kill]

#enddef

#define ZURG_CONVERSATION

	[message]
	description=Zurg
	message= _ "Congratulations, some of trolls didn't think you strong enough to beat dwarves."
	[/message]

	[message]
	speaker=second_unit
	message= _ "Where did you come from?"
	[/message]

	[message]
	description=Zurg
	message= _ "There many secret tunnels that you sun dwellers no know of. Only troll know. We smarter than you think. Zurg would have killed dwarves himself, but he was just sent back from where real fighting is."
	[/message]

	[message]
	speaker=second_unit
	message= _ "The real fighting? I thought that what we were waist-deep in?"
	[/message]

	[message]
	description=Zurg
	message= _ "While you fighting another clan of dwarves sneak around flanked us. They tricksy like that. We must leave you and run back to defend women and little trolls. Dwarves never give up, many trolls die today, very hard fighting. But dwarves make mistake, you stronger than dwarf or troll thought. You trolls secret weapon."
	[/message]

	[message]
	speaker=second_unit
	message= _ "How do you mean?"
	[/message]

	[message]
	description=Zurg
	message= _ "Dwarves always think they best fighters around. The think you not a big worry, so they leave only a few dwarves guarding their main stronghold. Just to the north, a big important dwarf is directing the battle. If you elves can break through dwarf defenses and kill him, then it will do much damage to dwarves, make them afraid and confused, easy prey for trolls. You do this are we can drive them back. Then troll leader can help show you how to return to surface. Zurg must go now, you kill dwarf chief. "
	[/message]

	#set new scenario objectives

	[objectives] 
	summary= _ "New Objectives:"
	show=yes 
		[objective] 
			description= _ "Defeat Dwarf Chieftain" 	
			condition=win 	
		[/objective] 
		[objective] 
			description= _ "Death of Kaleh, Nym or Zhul" 
			condition=lose 
		[/objective] 
	[/objectives]

#enddef


#define GRENDEL_CONVERSATION

	[message]
	description=Grendel
	message= _ "Congratulations, some of me boys didn't think you could beat the trolls."
	[/message]

	[message]
	speaker=second_unit
	message= _ "Where did you come from?"
	[/message]

	[message]
	description=Grendel
	message= _ "Don't think you know all the tunnels and passages that twist through these caves, elf. I would have killed him myself, but I was just sent back from the main front of the battle."
	[/message]

	[message]
	speaker=second_unit
	message= _ "The front? I thought this was was the front."
	[/message]

	[message]
	description=Grendel
	message= _ "While you were fighting a seperate clan of trolls sneaked around our sentries and flanked us, attacking our supply depots. There are more of those stinking buggers than we had originally thought. To tell you the truth, we are hard pressed. We're going to have to pull back all our forces in these caves to reinforce the back lines. But you victory here has produced a unexpected opportunity."
	[/message]

	[message]
	speaker=second_unit
	message= _ "It has?"
	[/message]

	[message]
	description=Grendel
	message= _ "The trolls thought they they could easily hold you off and so they left only a token force defending their main base. One of their leaders is directing the battle from just south of here. If you can break through their lines and kill him, then it will help confuse and frighten their warriors and we can drive them back. If you do this our leader has promised to help you return your people to the sunlit lands. I got to run now, more messages to deliver. You'll know the head troll when you see him, he's big, green and extra ugly. "
	[/message]

	#set new scenario objectives

	[objectives] 
	summary= _ "New Objectives:"
	show=yes 
		[objective] 
			description= _ "Defeat Troll Chieftain" 	
			condition=win 	
		[/objective] 
		[objective] 
			description= _ "Death of Kaleh, Nym or Zhul" 
			condition=lose 
		[/objective] 
	[/objectives]

#enddef

#send in troll messenger to tell player to continue north

[event]
name=die

[filter]
description=Fundin
[/filter]

[message]
description=Fundin
message= _ "The rest is silence..."
[/message]

[kill]
description=Fundin
animate=yes
[/kill]

[set_variable]
name=dead_dwarf_leaders
add=1
[/set_variable]

[if]
	[variable]
	name=dead_dwarf_leaders
	numerical_equals=2
	[/variable]

	[then]
	
	{DWARVES_DEAD}

	[terrain]
	x=20,19,19,18,17
	y=41,42,43,43,44
	letter=u
	[/terrain]

	{UNIT_ (Troll2) (Zurg) 2 20 41}

	[remove_shroud]
	x=19-23
	y=39-43
	side=1
	[/remove_shroud]

	[delay]
	time=200
	[/delay]

	{ZURG_CONVERSATION}

	[kill]
	description=Zurg
	animate=no
	[/kill]

	[terrain]
	x=20,19,19,18,17
	y=41,42,43,43,44
	letter=W
	[/terrain]

	[message]
	speaker=second_unit
	message= _ "Their knowledge of these tunnels is uncanny. I could have sworn that wall was solid rock."
	[/message]
	
	[/then]
[/if]

[/event]

[event]
name=die

[filter]
description=Nori
[/filter]

[message]
description=Nori
message= _ "I go to my ancestors..."
[/message]

[kill]
description=Nori
animate=yes
[/kill]

[set_variable]
name=dead_dwarf_leaders
add=1
[/set_variable]

[if]
	[variable]
	name=dead_dwarf_leaders
	numerical_equals=2
	[/variable]

	[then]

	{DWARVES_DEAD}

	[terrain]
	x=51,52,53,54,55
	y=39,39,40,39,40
	letter=u
	[/terrain]

	{UNIT_ (Troll2) (Zurg) 2 51 39}

	[remove_shroud]
	x=49-52
	y=37-40
	side=1
	[/remove_shroud]

	[delay]
	time=200
	[/delay]

	{ZURG_CONVERSATION}

	[kill]
	description=Zurg
	animate=no
	[/kill]

	[terrain]
	x=51,52,53,54,55
	y=39,39,40,39,40
	letter=W
	[/terrain]

	[message]
	speaker=second_unit
	message= _ "Their knowledge of these tunnels is uncanny. I could have sworn that wall was solid rock."
	[/message]

	[/then]
[/if]

[/event]

#send in dwarf messenger to tell player to continue south

[event]
name=die

[filter]
description=Thungar
[/filter]

[message]
description=Thungar
message= _ "Arrggg!!!"
[/message]

[kill]
description=Thungar
animate=yes
[/kill]

[set_variable]
name=dead_troll_leaders
add=1
[/set_variable]

[if]
	[variable]
	name=dead_troll_leaders
	numerical_equals=2
	[/variable]

	[then]
	
	{TROLLS_DEAD}

	[terrain]
	x=52,53,53,52,52
	y=68,68,67,66,65
	letter=u
	[/terrain]

	{UNIT_ (Dwarvish Pathfinder) (Grendel) 5 52 68}

	[remove_shroud]
	x=46-53
	y=69-67
	side=1
	[/remove_shroud]

	[delay]
	time=200
	[/delay]

	{GRENDEL_CONVERSATION}

	[kill]
	description=Grendel
	animate=no
	[/kill]

	[terrain]
	x=52,53,53,52,52
	y=68,68,67,66,65
	letter=W
	[/terrain]

	[message]
	description=second_unit
	message= _ "That would be my description of all the trolls. Still the dwarves' knowledge of these tunnels is uncanny. I could have sworn that wall was solid rock."
	[/message]

	[/then]
[/if]

[/event]

[event]
name=die

[filter]
description=Gnarl
[/filter]

[message]
description=Gnarl
message= _ "I will be avenged..."
[/message]

[kill]
description=Gnarl
animate=yes
[/kill]

[set_variable]
name=dead_troll_leaders
add=1
[/set_variable]

[if]
	[variable]
	name=dead_troll_leaders
	numerical_equals=2
	[/variable]

	[then]
	
	{TROLLS_DEAD}

	[terrain]
	x=21,20,19,18,17
	y=73,73,73,72,71
	letter=u
	[/terrain]

	[delay]
	time=200
	[/delay]

	{UNIT_ (Dwarvish Pathfinder) (Grendel) 5 21 73}

	[remove_shroud]
	x=20-26
	y=70-73
	side=1
	[/remove_shroud]

	{GRENDEL_CONVERSATION}

	[kill]
	description=Grendel
	animate=no
	[/kill]

	[terrain]
	x=21,20,19,18,17
	y=73,73,73,72,71
	letter=W
	[/terrain]

	[message]
	description=second_unit
	message= _ "That would be my description of all the trolls. Still the dwarves' knowledge of these tunnels is uncanny. I could have sworn that wall was solid rock."
	[/message]


	[/then]
[/if]

[/event]

# Event 7: Dwarf Sergeant and his Conscripts

[event]
name=sighted

[filter]
	x,y=14,36
[/filter]

[filter_second]
	side=1
[/filter_second]

[if]
	[variable]
	name=saw_sergeant
	numerical_equals=0
	[/variable]

	[then]

	[set_variable]
	name=saw_sergeant
	value=1
	[/set_variable]

[remove_shroud]
	side=1
	x=11-17
	y=33-39
[/remove_shroud]

#reduced to 2 conscripts
#{UNIT_T (Dwarvish Fighter) (Dwarf Conscript) 4 12 35}
{UNIT_T (Dwarvish Thunderer) (Dwarf Conscript) 4 12 36}
{UNIT_T (Dwarvish Scout) (Dwarf Conscript) 4 12 37}

[message]
description=Dwarf Sergeant
message= _ "Do you what the first task of any dwarven warrior is, runt?"
[/message]

[message]
x,y=12,37
message= _ "Sir?"
[/message]

[message]
description=Dwarf Sergeant
message= _ "Constant vigilance boys, the enemy could be anywhere!"
[/message]

[message]
x,y=12,36
message= _ "But Sir..."
[/message]

[message]
description=Dwarf Sergeant
message= _ "Did I give you permissions to speak? Did I?"
[/message]

[message]
description=Dwarf Sergeant
message= _ "I was killing trolls when you were in swaddling clothes. I wrote the book on killing trolls. And you're not going anywhere until I'm done with you."
[/message]

[message]
x,y=12,37
message= _ "But Sir, behind you..."
[/message]

[message]
description=Dwarf Sergeant
message= _ "Oh let me guess, a big nasty troll, right? And when I turn around you flee like the cowards you are. Do you think I'm stupid enough to fall for that one?"
[/message]

[message]
x,y=12,36
message= _ "I can't take it any longer, save us!"
[/message]

[message]
description=Dwarf Sergeant
message= _ "Oh grow a backbone.....Come on boys, kill the intruder!"
[/message]

	[/then]
[/if]

[/event]


[event]
name=moveto

[filter]
x=12-17
y=33-40
side=1
[/filter]

[if]
	[variable]
	name=saw_sergeant
	numerical_equals=0
	[/variable]

	[then]

	[set_variable]
	name=saw_sergeant
	value=1
	[/set_variable]

[remove_shroud]
	side=1
	x=11-17
	y=33-39
[/remove_shroud]

#reduced to 2 conscripts
#{UNIT_T (Dwarvish Fighter) (Dwarf Conscript) 4 12 35}
{UNIT_T (Dwarvish Thunderer) (Dwarf Conscript) 4 12 36}
{UNIT_T (Dwarvish Scout) (Dwarf Conscript) 4 12 37}

[message]
description=Dwarf Sergeant
message= _ "Do you what the first task of any dwarven warrior is, runt?"
[/message]

[message]
x,y=12,37
message= _ "Sir?"
[/message]

[message]
description=Dwarf Sergeant
message= _ "Constant vigilance boys, the enemy could be anywhere!"
[/message]

[message]
x,y=12,36
message= _ "But Sir..."
[/message]

[message]
description=Dwarf Sergeant
message= _ "Did I give you permissions to speak? Did I?"
[/message]

[message]
description=Dwarf Sergeant
message= _ "I was killing trolls when you were in swaddling clothes. I wrote the book on killing trolls. And you're not going anywhere until I'm done with you."
[/message]

[message]
x,y=12,37
message= _ "But Sir, behind you..."
[/message]

[message]
description=Dwarf Sergeant
message= _ "Oh let me guess, a big nasty troll, right? And when I turn around you flee like the cowards you are. Do you think I'm stupid enough to fall for that one?"
[/message]

[message]
x,y=12,36
message= _ "I can't take it any longer, save us!"
[/message]

[message]
description=Dwarf Sergeant
message= _ "Oh grow a backbone.....Come on boys, kill the intruder!"
[/message]

	[/then]
[/if]

[/event]

#funny death message from one of the conscripts
[event]
name=die

[filter]
type=Dwarvish Thunderer
description=Dwarf Conscript
[/filter]

[if]
	[have_unit]
	description=Dwarf Sergeant
	[/have_unit]

	[then]

	[message]
	speaker=unit
	message= _ "I love you Sarge..."
	[/message]

	[/then]
[/if]

[/event]

#moveto version

#for now assume unit is an elf

[event]
name=moveto

[filter]
x=12-17
y=33-40
race=elf
side=1
[/filter]

[if]
	[variable]
	name=saw_sergeant
	numerical_equals=0
	[/variable]

	[then]

	[set_variable]
	name=saw_sergeant
	value=1
	[/set_variable]

[remove_shroud]
	side=1
	x=11-17
	y=33-39
[/remove_shroud]

#reduced to 2 conscripts
#{UNIT_T (Dwarvish Fighter) (Dwarf Conscript) 4 12 35}
{UNIT_T (Dwarvish Thunderer) (Dwarf Conscript) 4 12 36}
{UNIT_T (Dwarvish Scout) (Dwarf Conscript) 4 12 37}

[message]
description=Dwarf Sergeant
message= _ "Do you what the first task of any dwarven warrior is, runt?"
[/message]

[message]
x,y=12,37
message= _ "Sir?"
[/message]

[message]
description=Dwarf Sergeant
message= _ "Constant vigilance boys, the enemy could be anywhere!"
[/message]

[message]
x,y=12,36
message= _ "But Sir..."
[/message]

[message]
description=Dwarf Sergeant
message= _ "Did I give you permissions to speak? Did I?"
[/message]

[message]
description=Dwarf Sergeant
message= _ "I was killing trolls when you were in swaddling clothes. I wrote the book on killing trolls. And you're not going anywhere until I'm done with you."
[/message]

[message]
x,y=12,37
message= _ "But Sir, behind you..."
[/message]

[message]
description=Dwarf Sergeant
message= _ "Oh let me guess, a big nasty troll, right? And when I turn around you flee like the cowards you are. Do you think I'm stupid enough to fall for that one?"
[/message]

[message]
x,y=12,36
message= _ "No, it's an elf!"
[/message]

[message]
description=Dwarf Sergeant
message= _ "What!?!.....Right...First task boys, kill the intruder!"
[/message]

	[/then]
[/if]

[/event]


# Event 8: Wounded Troll

#sighted version

[event]
name=sighted

[filter]
	x,y=8,30
[/filter]

[filter_second]
	side=1
[/filter_second]

[if]
	[variable]
	name=saw_troll_prisoner
	numerical_equals=0
	[/variable]

	[then]

	[set_variable]
	name=saw_troll_prisoner
	value=1
	[/set_variable]

[remove_shroud]
	side=1
	x=7-9
	y=28-35
[/remove_shroud]

[unit]
	type=Troll2
	description=Grog
	x=8
	y=29
	side=2
	hitpoints=25
	[modifications]
		{TRAIT_STRONG}
		{TRAIT_RESILIENT}
	[/modifications]
[/unit]

[message]
description=Vengeful Dwarf
message= _ "Ha, you're trapped. I've got you right where I want you, and this time no one is gonna save you."
[/message]

[message]
speaker=second_unit
message= _ "How did a troll get stuck all the way back here?"
[/message]

	[/then]
[/if]

[/event]

#moveto version

[event]
name=moveto

[filter]
x=8
y=29-35
side=1
[/filter]

[if]
	[variable]
	name=saw_troll_prisoner
	numerical_equals=0
	[/variable]

	[then]

	[set_variable]
	name=saw_troll_prisoner
	value=1
	[/set_variable]

[remove_shroud]
	side=1
	x=7-9
	y=28-35
[/remove_shroud]

[unit]
	type=Troll2
	description=Grog
	x=8
	y=29
	side=2
	hitpoints=20
	[modifications]
		{TRAIT_STRONG}
		{TRAIT_RESILIENT}
	[/modifications]
[/unit]

[message]
description=Vengeful Dwarf
message= _ "Ha, you're trapped. I've got you right where I want you, and this time no one is gonna save you."
[/message]

[message]
speaker=unit
message= _ "How did a troll get stuck all the way back here?"
[/message]

	[/then]
[/if]
[/event]


[event]
name=die

[filter]
description=Vengeful Dwarf
[/filter]

[kill]
description=Vengeful Dwarf
animate=no
[/kill]

[message]
description=Grog
message= _ "Thank you. Grog got lost and there were so many smelly dwarves. If you hadn't come Grog would have been killed. Grog owes you his life."
[/message]

[store_unit]
[filter]
	description=Grog
[/filter]

variable=trollstats
[/store_unit]

[set_variable]
name=trollstats.side
value=1
[/set_variable]

[set_variable]
name=trollstats.moves
value=5
[/set_variable]

[unstore_unit]
variable=trollstats
[/unstore_unit]

{CLEAR_VARIABLE trollstats}

[/event]


# Event 11: Troll Interrogators

#when player appears 3 trolls are interrogating a wounded dwarf
#when they see the player they kill the dwarf. The other says
#"The prisoners must not be allowed to escape. Kill the other prisoner
#while we hold them off!"

#Player has X turns to reach side tunnel where prisoner is before he dies

#Troll and Troll whelp try to hold off player

# create trolls well in advance of player entering cave
# this makes sure that player can't move into trolls hexes
# I am forced to make trolls into guardians to keep them
# in their places

#moveto version
[event]
name=moveto

[filter]
	x=13-20
	y=71-77
	side=1
[/filter]

[if]
	[variable]
	name=saw_interrogators
	numerical_equals=0
	[/variable]
	
	[then]

	[set_variable]
	name=saw_interrogators
	value=1
	[/set_variable]

	[remove_shroud]
	x=13-21
	y=71-78
	side=1
	[/remove_shroud]

	[unit]
	type=Dwarvish Fighter
	description=Wounded Dwarf
	x=15
	y=74
	side=5
	hitpoints=5
	[/unit]

	[message]
	description=Troll Interrogator
	message= _ "Tell us where you leader is hiding!"
	[/message]

	[message]
	description=Wounded Dwarf
	message= _ "Never!"
	[/message]

		[message]
	description=Troll Assistant
	message= _ "Master, look!"
	[/message]

	[message]
	description=Troll Interrogator
	message= _ "Hah! You think you can save your friends. You are wrong. Ulg, go kill the other prisoner. We will deal with these fools."
	[/message]

	[message]
	x,y=15,75
	message= _ "Yes master, I'll make him suffer."
	[/message]

	[kill]
	x,y=15,75
	animate=no
	[/kill]

	[move_unit_fake]
	type=Troll Whelp
	x=15,14,13,12,11,10
	y=75,75,75,74,74,73
	[/move_unit_fake]

	[hide_unit]
	x,y=14,73
	[/hide_unit]

	[redraw]
	[/redraw]

	{PUT_IMG troll-grunt-attack.png 14 73}

	[redraw]
	[/redraw]

	[delay]
	time=300
	[/delay]

	[removeitem]
	x,y=14,73
	[/removeitem]

	[unhide_unit]
	[/unhide_unit]

	[message]
	description=Wounded Dwarf
	message= _ "Aaahhhh!"
	[/message]

	[kill]
	description=Wounded Dwarf
	animate=yes
	[/kill]

	[message]
	speaker=unit
	message= _ "If we move fast we might be able to save the other prisoner before he gets killed too."
	[/message]

	[/then]
[/if]

[/event]

#sighted version
[event]
name=sighted

[filter]
	description=Troll Assistant
[/filter]

[filter_second]
	side=1
[/filter_second]

[if]
	[variable]
	name=saw_interrogators
	numerical_equals=0
	[/variable]
	
	[then]

	[set_variable]
	name=saw_interrogators
	value=1
	[/set_variable]

	[remove_shroud]
	x=13-21
	y=71-78
	side=1
	[/remove_shroud]

	[unit]
	type=Dwarvish Fighter
	description=Wounded Dwarf
	x=15
	y=74
	side=5
	hitpoints=5
	[/unit]

	[message]
	description=Troll Interrogator
	message= _ "Tell us where you leader is hiding!"
	[/message]

	[message]
	description=Wounded Dwarf
	message= _ "Never!"
	[/message]

	[message]
	description=Troll Assistant
	message= _ "Master, look!"
	[/message]

	[message]
	description=Troll Interrogator
	message= _ "Hah! You think you can save your friends. You are wrong. Ulg, go kill the other prisoner. We will deal with these fools."
	[/message]

	[message]
	x,y=15,75
	message= _ "Yes master, I'll make him suffer."
	[/message]

	[kill]
	x,y=15,75
	animate=no
	[/kill]

	[move_unit_fake]
	type=Troll Whelp
	x=15,14,13,12,11,10
	y=75,75,75,74,74,73
	[/move_unit_fake]

	[hide_unit]
	x,y=14,73
	[/hide_unit]

	[redraw]
	[/redraw]

	{PUT_IMG troll-grunt-attack.png 14 73}

	[redraw]
	[/redraw]

	[delay]
	time=300
	[/delay]

	[removeitem]
	x,y=14,73
	[/removeitem]

	[unhide_unit]
	[/unhide_unit]

	[message]
	description=Wounded Dwarf
	message= _ "Aaahhhh!"
	[/message]

	[kill]
	description=Wounded Dwarf
	animate=yes
	[/kill]

	[message]
	speaker=second_unit
	message= _ "If we move fast we might be able to save the other prisoner before he gets killed too."
	[/message]

	[/then]
[/if]

[/event]


# Event 12: Wounded Dwarf

#Troll whelp tries to kill wounded dwarven level 2 defender

[event]
name=moveto

[filter]
	x=7-13
	y=72-75
	side=1
[/filter]

[if]
	[variable]
	name=saw_dwarf_prisoner
	numerical_equals=0
	[/variable]
	
	[then]

	[set_variable]
	name=saw_dwarf_prisoner
	value=1
	[/set_variable]

	[remove_shroud]
	x=6-13
	y=69-76
	side=1
	[/remove_shroud]

	[unit]
	type=Dwarvish Stalwart2 
	description=Rogrimir
	x=7
	y=72
	side=5
	hitpoints=20
	[modifications]
		{TRAIT_RESILIENT}
		{TRAIT_QUICK}
	[/modifications] 
	[/unit]

	[message]
	description=Ulg
	message= _ "I'm gonna make you squeal dwarf!"
	[/message]

	[/then]
[/if]

[/event]

[event]
name=sighted

[filter]
	x,y=8,72
[/filter]

[filter_second]
	side=1
[/filter_second]

[if]
	[variable]
	name=saw_dwarf_prisoner
	numerical_equals=0
	[/variable]

	[then]

	[set_variable]
	name=saw_dwarf_prisoner
	value=1
	[/set_variable]

	[remove_shroud]
	x=6-13
	y=69-76
	side=1
	[/remove_shroud]

	[unit]
	type=Dwarvish Stalwart2 
	description=Rogrimir
	x=7
	y=72
	side=5
	hitpoints=15
	[modifications]
		{TRAIT_RESILIENT}
		{TRAIT_QUICK}
	[/modifications] 
	[/unit]

	[message]
	description=Ulg
	message= _ "I'm gonna make you squeal dwarf!"
	[/message]

	[/then]
[/if]

[/event]

[event]
name=die

[filter]
description=Ulg
[/filter]

[kill]
description=Ulg
animate=no
[/kill]

[message]
description=Rogrimir
message= _ "I owe you my life. I can't believe I was captured when those all around me died fighting gloriously. I'm so ashamed. I could not protect them....but I will guard you with my life, even if I have to follow you to the ends of the earth. Now lead me to the trolls and let me avenge my friends' deaths!"
[/message]

[store_unit]
[filter]
	description=Rogrimir
[/filter]

variable=dwarfstats
[/store_unit]

[set_variable]
name=dwarfstats.side
value=1
[/set_variable]

[set_variable]
name=dwarfstats.moves
value=5
[/set_variable]

[unstore_unit]
variable=dwarfstats
[/unstore_unit]

{CLEAR_VARIABLE dwarfstats}

[/event]


# Event 13: Tunnel cave-ins

[event]
name=moveto

[filter]
x=27-32
y=31-35
side=1
[/filter]

[remove_shroud]
x=30-32
y=31-33
side=1
[/remove_shroud]

[if]
	[variable]
	name=first_tunnel
	numerical_equals=1
	[/variable]

	[then]

	{UNIT_ (Dwarvish Stalwart) (Dwarf Scout) 6 31 33}

	[delay]
	time=200
	[/delay]

	[message]
	description="Dwarf Scout"
	message= _ "Here they come! Blow the charges!"
	[/message]

	[kill]
	description=Dwarf Scout
	animate=no
	[/kill]

	[move_unit_fake]
	type=Dwarvish Stalwart
	x=31,31,32,33,34,35,35
	y=33,32,31,31,30,31,29
	[/move_unit_fake]

	[scroll]
	x=20
	[/scroll]
	[scroll]
	x=-20
	[/scroll]
	[scroll]
	x=20
	[/scroll]
	[scroll]
	x=-20
	[/scroll]

	[terrain]
	x,y=32,31
	letter=W
	[/terrain]

	{PUT_IMG terrain/rocks.png 31 32}
	{PUT_IMG terrain/rocks.png 33 31}

	[set_variable]
	name=first_tunnel
	value=0
	[/set_variable]

	[/then]

	[else]

	{UNIT_ (Dwarvish Guardsman) (Dwarf Scout) 6 31 33}

	[message]
	description="Dwarf Scout"
	message= _ "They're coming this way too! Blow the charges!"
	[/message]

	[redraw]
	[/redraw]

	[delay]
	time=1000
	[/delay]
	
	[message]
	description="Dwarf Scout"
	message= _ "What!?! Nothing happened! Who in Moradin's name rigged the darn charges anyway? I'm going to have to hold them off by myself. "
	[/message]

	[/else]
[/if]

[/event]

[event]
name=moveto

[filter]
x=37-44
y=29-33
side=1
[/filter]

[remove_shroud]
x=39-41
y=29-31
side=1
[/remove_shroud]

[if]
	[variable]
	name=first_tunnel
	numerical_equals=1
	[/variable]

	[then]

	{UNIT_ (Dwarvish Stalwart) (Dwarf Scout) 6 40 30}

	[delay]
	time=200
	[/delay]

	[message]
	description="Dwarf Scout"
	message= _ "Here they come! Blow the charges!"
	[/message]

	[kill]
	description=Dwarf Scout
	animate=no
	[/kill]

	[move_unit_fake]
	type=Dwarvish Stalwart
	x=40,39,38,37,36,35
	y=30,31,30,30,29,29
	[/move_unit_fake]

	[scroll]
	x=20
	[/scroll]
	[scroll]
	x=-20
	[/scroll]
	[scroll]
	x=20
	[/scroll]
	[scroll]
	x=-20
	[/scroll]

	[terrain]
	x,y=39,31
	letter=W
	[/terrain]

	{PUT_IMG terrain/rocks.png 40 30}
	{PUT_IMG terrain/rocks.png 38 30}

	[set_variable]
	name=first_tunnel
	value=0
	[/set_variable]

	[/then]

	[else]

	{UNIT_ (Dwarvish Guardsman) (Dwarf Scout) 6 40 30}

	[message]
	description="Dwarf Scout"
	message= _ "They're coming this way too! Blow the charges!"
	[/message]

	[redraw]
	[/redraw]

	[delay]
	time=1000
	[/delay]
	
	[message]
	description="Dwarf Scout"
	message= _ "What!?! Nothing happened! Who in Moradin's name rigged the darn charges anyway? I'm going to have to hold them off by myself. "
	[/message]
	
	[/else]
[/if]

[/event]


# Event 14: Bridge/Chasm Fight

#Dwarf tries to prove he can defeat elves without resorting to trickery
#doesn't want to be a coward

[event]
name=moveto

[filter]
x=33-37
y=24-31
side=1
[/filter]

[remove_shroud]
x=31-39
y=23-32
side=1
[/remove_shroud]

{UNIT_T (Dwarvish Sentinel) (Jorgi) 6 35 25}

#ifdef HARD
{UNIT_T (Dwarvish Steelclad) (Dwarf Guard) 6 34 26}
{UNIT_T (Dwarvish Steelclad) (Dwarf Guard) 6 35 27}
{UNIT_T (Dwarvish Steelclad) (Dwarf Guard) 6 36 26}
#else
{UNIT_T (Dwarvish Fighter) (Dwarf Guard) 6 34 26}
{UNIT_T (Dwarvish Fighter) (Dwarf Guard) 6 35 27}
{UNIT_T (Dwarvish Fighter) (Dwarf Guard) 6 36 26}
#endif

{UNIT_T (Dwarvish Pathfinder) (Dwarf Guard) 6 34 25}
{UNIT_T (Dwarvish Pathfinder) (Dwarf Guard) 6 36 25}

#ifdef EASY
{UNIT_T (Dwarvish Thunderguard) (Dwarf Guard) 6 35 26}
#else
{UNIT_T (Dwarvish Dragonguard) (Dwarf Guard) 6 35 26}
#endif

[message]
description=Jorgi
message= _ "It was a mistake to depend on trickery, we will defeat you fighting face to face. A true dwarf always looks his opponent in the eye when he kills him!"
[/message]

[message]
description=Jorgi
message= _ "So I challenge you, man to man, if you are not cowards, step out onto these bridges and meet your fate!"
[/message]

[/event]

#define BACKUP_CHARGES

	[scroll]
	x=20
	[/scroll]
	[scroll]
	x=-20
	[/scroll]
	[scroll]
	x=20
	[/scroll]
	[scroll]
	x=-20
	[/scroll]

	[terrain]
	x=28,29
	y=20,21
	letter=W
	[/terrain]

	{PUT_IMG terrain/rocks.png 28 19}
	{PUT_IMG terrain/rocks.png 30 21}

#enddef

[event]
name=moveto

[filter]
y=26
side=1
[/filter]

[if]
	[have_unit]
	description=Jorgi
	[/have_unit]

	[then]

	[message]
	description=Jorgi
	message= _ "It's not use! We can't hold them back." 
	[/message]

	[/then]

	[else]

	[message]
	description=Dwarf High Guard
	message= _ "It's not use! We can't hold them back." 
	[/message]

	[/else]

[/if]

[/event]

[event]
name=die

[filter]
description=Jorgi
[/filter]

[if]
	[variable]
	name=bridge_blown
	numerical_equals=0
	[/variable]
	
	[then]

	[set_variable]
	name=bridge_blown
	value=1
	[/set_variable]

	[message]
	description=Jorgi
	message= _ "I couldn't do it. Blow the backup charges! If we can't stop them the maybe the black lake will."
	[/message]

	{BACKUP_CHARGES}

	[/then]
[/if]

[/event]

[event]
name=moveto

[filter]
x=28-33
y=19-23
side=1
[/filter]

[if]

	[variable]
	name=bridge_blown
	numerical_equals=0
	[/variable]

	[then]

	[set_variable]
	name=bridge_blown
	value=1
	[/set_variable]

	[if]
		[have_unit]
		description=Jorgi
		[/have_unit]

		[then]

		[message]
		description=Jorgi
		message= _ "They've crossed the chasm. Blow the backup charges! If we can't stop them the maybe the black lake will." 
		[/message]

		[/then]

		[else]

		[message]
		description=Dwarf High Guard
		message= _ "They've crossed the chasm. Blow the backup charges! If we can't stop them the maybe the black lake will." 
		[/message]

		[/else]

	[/if]

	{BACKUP_CHARGES}

	[/then]

[/if]

[/event]

# Event 15: Vampire Bats

[event]
name=moveto

[filter]
x=42-50
y=10-21
side=1
[/filter]

[message]
speaker=unit
message= _ "It's a huge underground lake. The water look dark and deep and is cold to the touch. There also seems to be some glowing moss on the walls which illuminates the cavern, making it easier to see."
[/message]

[/event]

#activate bats and create dwarvish hermit unit
[event]
name=moveto

[filter]
x=42-44
y=15-20
side=1
[/filter]

[set_variable]
name=tripped_bats
value=1
[/set_variable]

[unit]
	description=Extra Hairy Bat
	type=Dread Bat
	x=58
	y=9
	side=8
	canrecruit=1
	upkeep=free
	[modifications]
		{TRAIT_STRONG}
		{TRAIT_RESILIENT}
	[/modifications]
[/unit]

#on easy, don't allow side to recruit dread bats, but create on at start

#ifdef EASY
[unit]
type=Dread Bat
side=8
x=57
y=10
moves=0
[/unit]
#endif

[modify_side]
	side=8
		
	#ifdef EASY
	income=8
	gold=90
	#endif
	#ifdef MEDIUM
	income=10
	gold=125
	#endif
	#ifdef HARD
	income=12
	gold=150
	#endif
[/modify_side]

[unit]
type=Dwarvish Stalwart
description=Dwarf Hermit
x=37
y=6
side=6 
ai_special=guardian
[modifications]
	{TRAIT_STRONG}
	{TRAIT_QUICK}
[/modifications]
[/unit]

[capture_village]
x,y=38,5
side=6
[/capture_village]

[/event]

[event]
name=sighted

[filter]
	type=Vampire Bat,Blood Bat,Dread Bat
[/filter]

[filter_second]
	side=1
[/filter_second]

[message]
speaker=second_unit
message= _ "Incoming! Ug, it's big, hairy, and nasty. I hate bats, I really hate bats."
[/message]

[/event]

[event]
name=die

[filter]
description=Big Hairy Bat
[/filter]

[message]
speaker=unit
message= _ "Grrraaawwwkkk!"
[/message]

[message]
speaker=second_unit
message= _ "Good Riddance."
[/message]

[/event]

# allow units around lake to look out over deep water
# artificially increase sight for units walking around lake

[event]
name=moveto
first_time_only=no

[filter]
x=35-57
y=3-22
side=1
[/filter]

[set_variable]
name=x_left
value=$x1
[/set_variable]

[set_variable]
name=x_left
add=-4
[/set_variable]

[set_variable]
name=x_right
value=$x1
[/set_variable]

[set_variable]
name=x_right
add=4
[/set_variable]

[set_variable]
name=y_up
value=$y1
[/set_variable]

[set_variable]
name=y_up
add=-3
[/set_variable]

[set_variable]
name=y_down
value=$y1
[/set_variable]

[set_variable]
name=y_down
add=3
[/set_variable]

[set_variable]
	name=lake_x
	format=$x_left-$x_right
[/set_variable]

[set_variable]
	name=lake_y
	format=$y_up-$y_down
[/set_variable]

[remove_shroud]
x=$lake_x
y=$lake_y
side=1
[/remove_shroud]

[/event]

# Event 16: Tentacles (2-3 level 1 tentacles appear every turn that player
# is in 48-52,13-16) Give warning when player reaches edge of ledge

# tentacles appear at start of player's turn

[event]
name=moveto

[filter]
x=43
y=17
side=1
[/filter]

[message]
speaker=unit
message= _ "The ledge just drops off here. The water might be shallow enough to wade across, but I think I vaguely see something moving underneath the surface. Maybe it's just fish, but I don't like the looks of it."
[/message]

[/event]

#define CREATE_TENTACLES

{RANDOM 43..46}

[set_variable]
name=tempx
value=$random
[/set_variable]

{RANDOM 13..16}

[set_variable]
name=tempy
value=$random
[/set_variable]

{UNIT_ (Giant Tentacle) () 9 $tempx $tempy}

{RANDOM 43..46}

[set_variable]
name=tempx
value=$random
[/set_variable]

{RANDOM 13..16}

[set_variable]
name=tempy
value=$random
[/set_variable]

{UNIT_ (Giant Tentacle) () 9 $tempx $tempy}

#ifdef EASY
#else

{RANDOM 43..46}

[set_variable]
name=tempx
value=$random
[/set_variable]

{RANDOM 13..16}

[set_variable]
name=tempy
value=$random
[/set_variable]

{UNIT_ (Giant Tentacle) () 9 $tempx $tempy}

#endif

#enddef

#create tentacles every time a side 1 unit is in area
#do this 3 times 

[event]
name=new turn
first_time_only=no

[store_locations]
	x=43-46
	y=13-16
	[filter]
	side=1
	[/filter]
	variable=lake_list
[/store_locations]

[set_variable]
	name=temp
	value=$lake_list.length
[/set_variable]

{CLEAR_VARIABLE lake_list}


[if]
	[variable]
	name=temp
	greater_than=0
	[/variable]	

	[then]

	[if]
		[variable]
		name=tentacle_count
		less_than=3
		[/variable]
		
		[then]

		{CREATE_TENTACLES}

		#choose what message to say
		[if]

			[variable]
			name=tentacle_count
			numerical_equals=0
			[/variable]
		
			[then]

			[message]
			x,y=37-46,12-19
			side=1
			message= _ "What are those?!?"
			[/message]
	
			[/then]
		
			[else]
		
			[message]
			x,y=37-46,12-19
			side=1
			message= _ "Here come more of them!"
			[/message]

			[/else]
		[/if]

		[/then]
	[/if]
	
	#either way, whenever a unit is in the area, increase the counter
	[if]
		[variable]
		name=tentacle_count
		less_than=3
		[/variable]

		[then]

		[set_variable]
		name=tentacle_count
		add=1
		[/set_variable]	

		[/then]
	[/if]

	[/then]
[/if]
	
[/event]

#tentacle death counter

[event]
name=die
first_time_only=no

[filter]
type=Giant Tentacle
[/filter]

[set_variable]
	name=tentacle_deaths
	add=1
[/set_variable]

[if]
	#ifdef EASY
	[variable]
	name=tentacle_deaths
	numerical_equals=6
	[/variable]
	#else
	[variable]
	name=tentacle_deaths
	numerical_equals=9
	[/variable]
	#endif
	
	[then]

	[message]
	x,y=37-46,12-19
	side=1
	message= _ "The movement under the water has stopped. I think we killed the last of them. Whatever 'them' was."
	[/message]

	[modify_side]
	side=8
	income=2
	[/modify_side]
	
	[/then]
[/if]

[/event]


# Event 17: Trigger Dwarf Lord's side 
# (also create hermit and capture village)
[event]
name=moveto

[filter]
x=29-34
y=12-17
side=1
[/filter]

[set_variable]
	name=entered_dwarf_lair
	value=1
[/set_variable]

#create dwarf chieftain
[unit]
	type=Dwarvish Lord
	description=Dwarf Chieftain
	canrecruit=1
	upkeep=full
	x=22
	y=16
	side=6
	[modifications]
		{TRAIT_STRONG}
		{TRAIT_RESILIENT}
	[/modifications]
[/unit]	

# lowered income of dwarf leader by 1, used to be 8,10,12

[modify_side]
	side=6
		
	#ifdef EASY
	income=6
	gold=125
	#endif
	#ifdef MEDIUM
	income=8
	gold=150
	#endif
	#ifdef HARD
	income=10
	gold=175
	#endif
[/modify_side]

#create dwarven defenders:

#on EASY difficulty, don't create Dwarvish Pathfinder

{UNIT_T (Dwarvish Fighter) (Dwarf High Guard) 6 27 10}
#ifdef EASY
#else
{UNIT_T (Dwarvish Pathfinder) (Dwarf High Guard) 6 21 13}
#endif
{UNIT_T (Dwarvish Thunderguard) (Dwarf High Guard) 6 23 15}
{UNIT_T (Dwarvish Guardsman) (Dwarf High Guard) 6 23 19}


#capture dwarf chieftan's villages

[capture_village]
x,y=22,11
side=6
[/capture_village]
[capture_village]
x,y=24,14
side=6
[/capture_village]
[capture_village]
x,y=25,19
side=6
[/capture_village]
[capture_village]
x,y=30,16
side=6
[/capture_village]
[capture_village]
x,y=27,10
side=6
[/capture_village]

[/event]

# Event 18: Dwarf Lord sighted event and death event

[event]
name=sighted

[filter]
	description=Dwarf Chieftain
[/filter]

[filter_second]
	side=1
[/filter_second]

[message]
description=Dwarf Chieftain
message= _ "So you've come at last. Let it end, here and now!"
[/message]

[/event]

[event]
name=die

[filter]
	description=Dwarf Chieftain
[/filter]

[message]
description=Dwarf Chieftain
message= _ "Paugh! Even in death I curse you! You will never escape these tunnels alive!"
[/message]

[message]
speaker=second_unit
message= _ "And so, at last, it ends."
[/message]

[message]
side=6
message= _ "The chieftain has fallen! Flee for your lives!"
[/message]

[kill]
side=6
animate=no
[/kill]

[terrain]
x=20,20,20,21,21,22
y=23,22,21,21,20,19
letter=u
[/terrain]

[move_unit_fake]
type=Troll Whelp
x=20,20,20,20,21,21,22
y=24,23,22,21,21,20,19
[/move_unit_fake]

{UNIT_ (Troll2) (Zurg) 2 22 19}

[remove_shroud]
	x=21-23
	y=18-20
	side=1
[/remove_shroud]

[delay]
time=200
[/delay]

[message]
description=Zurg
message= _ "You did good. With dwarf leader dead, cowardly dwarves flee before us. This war not over, still much more fighting, but elf and troll have won first battle. We thank you. Our great leader has allowed you to come speak with him. Great honor, never has one of your kind ever been allowed in his presence. But he wishes to talk with you and reward you. Please come with us."
[/message]

[message]
description=Nym
message= _ "You think they could have told us about all these secret tunnels beforehand. It would have saved us a lot of unnecessary fighting in actually getting to the dwarf chieftain."
[/message]

[message]
description=Zhul
message= _ "I think they wanted to further test our prowess in battle. And perhaps they didn't entirely trust us with all their secrets."
[/message]

[message]
description=Kaleh
message= _ "Shhhh, you two. Yes, of course, we would be honored to come and meet your leader. But we left many of our people back up the passageway and I fear that even now these caves aren't safe. Can you help us escort my people to safety?"
[/message]

[message]
description=Zurg
message= _ "Hmmmm, yes, yes we can help. We have a few big caves your people can stay in, and I get some troll warriors to help escort you there. Great leader wouldn't want any unpleasant surprises. Show me where your people are hiding and we will help you move them to our caves."
[/message]

[message]
description=Kaleh
message= _ "I thank you. Come on people, no celebrating yet, we still have work left to do!"
[/message]

[endlevel]
result=victory
next_scenario="TrollInterlude"
bonus=yes
[/endlevel]

[/event]

# DWARF EASTER EGG EVENTS

# Event 19: Hermit Sighted event, Death of Hermit event
# Hermit lives alone on island in the lake, guarding his amulet

[event]
name=sighted

[filter]
	description=Dwarf Hermit
[/filter]

[filter_second]
	side=1
[/filter_second]

[message]
description=Dwarf Hermit
message= _ "They've come for my precious. It's mine, yes it is. They shant have it, no they shant. We will kill the nasty elfses, yes we will."
[/message]

[/event]

[event]
name=die

[filter]
	description=Dwarf Hermit
[/filter]

[message]
description=Dwarf Hermit
message= _ "Curse them! We hates them!"
[/message]

[message]
speaker=second_unit
message= _ "What's this? His clothes were in rags, and yet he had this ancient jeweled amulet hanging from around his neck. It contains a huge amethyst that seems to pulse faintly with a strange purple light. I wonder where he got such a trinket?"
[/message]

[set_variable]
name=dwarf_amulet
value=1
[/set_variable]

[/event]

# Event 19.5 water serpent attacks any unit that tries to walk around 
# the edge of cave (except for flying shyde/star)

[event]
name=moveto

[filter]
	[not]
	type=Desert Shyde, Desert Star 
	[/not]
x=33-80
y=8-11
side=1
[/filter]

{UNIT_ (Water Serpent) (Lake Monster) 9 34 10}

[message]
description=Lake Monster
message= _ "Rrrraaaarrrr!"
[/message]

[message]
speaker=unit
message= _ "Not again! I really really hate things that live underwater!"
[/message]

[/event]

# Event 20: Moveto rune statue, open door events
 
[event]
name=moveto
first_time_only=no

[filter]
x,y=61,21
side=1
[/filter]

# if dwarf_amulet = 1 open door desc set dwarf_door to 2

[if]
	[variable]
	name=dwarf_amulet
	numerical_equals=1
	[/variable]

	[then]

	[message]
	speaker=unit
	message= _ "Hey wait a minute, that amulet glows the same color as theis rune. Maybe if I put the amulet on and step into the rune..."
	[/message]

	[colour_adjust] 
	red,green,blue=246,0,243
	[/colour_adjust] 

	[scroll]
	x=20
	[/scroll]
	[scroll]
	x=-20
	[/scroll]
	[scroll]
	x=20
	[/scroll]
	[scroll]
	x=-20
	[/scroll]

	[terrain]
	x,y=62,21
	letter=u
	[/terrain]

	{PUT_IMG terrain/rocks.png 62 21}

	[colour_adjust] 
	red,green,blue=0,0,0 
	[/colour_adjust]

	[removeitem]
	x,y=61,21
	[/removeitem]

	[message]
	speaker=unit
	message= _ "Woah. That was pretty impressive. The rune just disappeared and the amulet stopped glowing, but what have they revealed? "
	[/message]

	[set_variable]
	name=dwarf_amulet
	value=2
	[/set_variable]
	
	[set_variable]
	name=dwarf_door
	value=2
	[/set_variable]

	[/then]
[/if]

# if dwarf_door = 1 repeat description

[if]
	[variable]
	name=dwarf_door
	numerical_equals=1
	[/variable]

	[then]

	[message]
	speaker=unit
	message= _ "The rune is still there, glowing mysteriously. I still have no idea why it was put here, but it's obviously powerful and magical, a combination of things which I am hesitant to mess with."
	[/message]

	[/then]
[/if]
 
# if dwarf_door = 0 print initial rune description set dwarf_door to 1

[if]
	[variable]
	name=dwarf_door
	numerical_equals=0
	[/variable]

	[then]

	[message]
	speaker=unit
	message= _ "What in Eloh's name is this? Someone has carved a glowing purple rune in the floor at the end of this passage. It must be magical. And this passage ends suddenly in a smooth stone wall. This can't be a coincidence. But the wall seems quite solid. I wonder who carved that rune and why?"
	[/message]

	[set_variable]
	name=dwarf_door
	value=1
	[/set_variable]
	
	[/then]
[/if]
	
[/event]

# Event 21: Ransack Dwarven Tomb

# if unit is a desert shyde, star, ranger or avenger
# then use alternate events so they don't lose their melee attack
# special abilities when they gain first strike

[event]
name=moveto
first_time_only=no

[filter]
type=Desert Shyde, Desert Star
x=65
y=24
side=1
[/filter]

[if]

	[variable]
	name=took_belt
	numerical_equals=0
	[/variable]

	[then]

	[message]
	speaker=unit
		
	message= _ "Based on the runes covering the walls this must be the tomb of some ancient dwarf. The tomb seems empty except for this ornate stone coffin. The skeleton inside the coffin has long since vanished into dust. All that's left are a few ceremonial trinkets and this shining golden belt. Inscribed on this inside are the words: 'May you have the quickness to draw first blood and the toughness to land the last blow.'  Grave robbing is never a good thing to do, but this belt looks magical and it's former owner certainly won't miss it."
	[option]
			
		message= _ "I fear no ghosts, I'll take it."
		[command]
			[set_variable]
			name=took_belt
			value=1
			[/set_variable]		
		[/command]
		[command]
			[message]
			speaker=unit
			message= _ "The belt fits perfectly! Somehow I feel tougher and quicker. This is too easy, there seem to have been no traps set upon the coffin. Today's my lucky day."
			[/message]	
		[/command]
					
		[command]

			[object]

			[filter]
			x=65
			y=24
			side=1
			[/filter]
			
			id=DwarvenBelt
			name="Dwarven Belt"
			description="The unit who wears this belt will gain 7 hit points and the first strike ability for his melee attack."
			
			[effect]
			apply_to=attack
			range=short
			set_special=magical, first strike
			[/effect]

			[effect]
			apply_to=hitpoints
			increase_total=7
			[/effect]
			
			[/object]
				
		[/command]

		[command]
		{UNIT_ (Ghost) (Angry Ghost) 9 63 22}

		[message]
		description=Angry Ghost
		message= _ "You who disturb my rest, come and join me in death!"
		[/message]

		[message]
		speaker=unit
		message= _ "Then again, maybe I spoke too soon."
		[/message]
		
		[/command]						
	[/option]
		
	[option]
	message= _ "On second thought, it's better to leave the dead in peace."
	
	[/option]

	[/message]

	[/then]
[/if]

[/event]


[event]
name=moveto
first_time_only=no

[filter]
type=Desert Avenger, Desert Ranger
x=65
y=24
side=1
[/filter]

[if]

	[variable]
	name=took_belt
	numerical_equals=0
	[/variable]

	[then]

	[message]
	speaker=unit
		
	message= _ "Based on the runes covering the walls this must be the tomb of some ancient dwarf. The tomb seems empty except for this ornate stone coffin. The skeleton inside the coffin has long since vanished into dust. All that's left are a few ceremonial trinkets and this shining golden belt. Inscribed on this inside are the words: 'May you have the quickness to draw first blood and the toughness to land the last blow.'  Grave robbing is never a good thing to do, but this belt looks magical and it's former owner certainly won't miss it."
	[option]
			
		message= _ "I fear no ghosts, I'll take it."
		[command]
			[set_variable]
			name=took_belt
			value=1
			[/set_variable]		
		[/command]
		[command]
			[message]
			speaker=unit
			message= _ "The belt fits perfectly! Somehow I feel tougher and quicker. This is too easy, there seem to have been no traps set upon the coffin. Today's my lucky day."
			[/message]	
		[/command]
					
		[command]

			[object]

			[filter]
			x=65
			y=24
			side=1
			[/filter]
			
			id=DwarvenBelt
			name="Dwarven Belt"
			description="The unit who wears this belt will gain 7 hit points and the first strike ability for his melee attack."
			
			[effect]
			apply_to=attack
			range=short
			set_special=backstab, first strike
			[/effect]

			[effect]
			apply_to=hitpoints
			increase_total=7
			[/effect]
			
			[/object]
				
		[/command]

		[command]
		{UNIT_ (Ghost) (Angry Ghost) 9 63 22}

		[message]
		description=Angry Ghost
		message= _ "You who disturb my rest, come and join me in death!"
		[/message]

		[message]
		speaker=unit
		message= _ "Then again, maybe I spoke too soon."
		[/message]
		
		[/command]						
	[/option]
		
	[option]
	message= _ "On second thought, it's better to leave the dead in peace."
	
	[/option]

	[/message]

	[/then]
[/if]

[/event]

[event]
name=moveto
first_time_only=no

[filter]
[not]
type=Desert Shyde, Desert Star, Desert Avenger, Desert Ranger
[/not]
x=65
y=24
side=1
[/filter]

[if]

	[variable]
	name=took_belt
	numerical_equals=0
	[/variable]

	[then]

	[message]
	speaker=unit
		
	message= _ "Based on the runes covering the walls this must be the tomb of some ancient dwarf. The tomb seems empty except for this ornate stone coffin. The skeleton inside the coffin has long since vanished into dust. All that's left are a few ceremonial trinkets and this shining golden belt. Inscribed on this inside are the words: 'May you have the quickness to draw first blood and the toughness to land the last blow.'  Grave robbing is never a good thing to do, but this belt looks magical and it's former owner certainly won't miss it."
	[option]
			
		message= _ "I fear no ghosts, I'll take it."
		[command]
			[set_variable]
			name=took_belt
			value=1
			[/set_variable]		
		[/command]
		[command]
			[message]
			speaker=unit
			message= _ "The belt fits perfectly! Somehow I feel tougher and quicker. This is too easy, there seem to have been no traps set upon the coffin. Today's my lucky day."
			[/message]	
		[/command]
					
		[command]

			[object]

			[filter]
			x=65
			y=24
			side=1
			[/filter]
			
			id=DwarvenBelt
			name="Dwarven Belt"
			description="The unit who wears this belt will gain 7 hit points and the first strike ability for his melee attack."
			
			[effect]
			apply_to=attack
			range=short
			set_special=first strike
			[/effect]

			[effect]
			apply_to=hitpoints
			increase_total=7
			[/effect]
			
			[/object]
				
		[/command]

		[command]
		{UNIT_ (Ghost) (Angry Ghost) 9 63 22}

		[message]
		description=Angry Ghost
		message= _ "You who disturb my rest, come and join me in death!"
		[/message]

		[message]
		speaker=unit
		message= _ "Then again, maybe I spoke too soon."
		[/message]
		
		[/command]						
	[/option]
		
	[option]
	message= _ "On second thought, it's better to leave the dead in peace."
	
	[/option]

	[/message]

	[/then]
[/if]

[/event]




# Event 22: Troll Lava Maze


# lava is ironically an alias of snow. Elves take 3 moves to cross it,
# except for mounted elves which take 4 (horses hate lava). Thus
# ensuring that no elf can move more than 2 hexes on lava
# with the exception of the desert shyde/star which can move 3 hexes

# At the start of each turn, all units except the shyde/star standing 
# on a lava hex take 25 damage, or 30 if diff is Challenging/Hard
# This damage can kill units.

# Desert Shyde/Star takes normal heat damage for floating over lava

[event]
name=new turn
first_time_only=no

	[store_locations]
	x=27-49
	y=80-96
	terrain=y
		[filter]
		side=1
		[/filter]
	variable=locs
	[/store_locations]

	{FOREACH locs i}

	[set_variable]
		name=temp_x
		to_variable=locs[$i].x
	[/set_variable]

	[set_variable]
		name=temp_y
		to_variable=locs[$i].y
	[/set_variable]

	[store_unit]
		[filter]
		x,y=$temp_x,$temp_y
		[/filter]
	variable=unitstats
	[/store_unit]

	[if]
		[variable]
		name=unitstats.type
		equals="Desert Shyde"
		[/variable]

		[or]
		[variable]
		name=unitstats.type
		equals="Desert Star"
		[/variable]
		[/or]
		
		[then]

		[set_variable]
		name=unitstats.hitpoints
		add=$heat_damage
		[/set_variable]

		[/then]

		[else]

		[set_variable]
		name=unitstats.hitpoints
		add=$lava_damage
		[/set_variable]

		[/else]

	[/if]
		
	#if unitstats.hitpoints is < 1, kill unit
	[if]
		[variable]
		name=unitstats.hitpoints
		less_than=1
		[/variable]

		[then]

		[kill]
		description=$unitstats.description
		animate=no
		[/kill]
		
		[/then]

	[/if]

	[if]
		[variable]
		name=unslow_kaleh
		numerical_equals=1
		[/variable]

		[variable]
		name=unitstats.description
		equals=Kaleh
		[/variable]

		[then]

		[set_variable]
		name=unitstats.status.slowed
		value="off"
		[/set_variable]

		[/then]
	[/if]


	[unstore_unit]
	variable=unitstats
	[/unstore_unit]


	{CLEAR_VARIABLE unitstats}
		
	{NEXT i}

	{CLEAR_VARIABLE locs}
[/event]


# At the start of each turn, all units in main cavern standing on a cave 
# floor hex take 3,4,5 damage from the heat. This damage is non-lethal.

[event]
name=new turn
first_time_only=no

	[store_locations]
	x=31-49,39-44,28-32
	y=81-93,94-95,84-91
	terrain=u
		[filter]
		side=1
		[/filter]
	variable=locs
	[/store_locations]

	{FOREACH locs i}

	[set_variable]
		name=temp_x
		to_variable=locs[$i].x
	[/set_variable]

	[set_variable]
		name=temp_y
		to_variable=locs[$i].y
	[/set_variable]

	[store_unit]
		[filter]
		x,y=$temp_x,$temp_y
		[/filter]
	variable=unitstats
	[/store_unit]

	[set_variable]
	name=unitstats.hitpoints
	add=$heat_damage
	[/set_variable]

	#if unitstats.hitpoints is < 1, kill unit
	[if]
		[variable]
		name=unitstats.hitpoints
		less_than=1
		[/variable]

		[then]

		[set_variable]
		name=unitstats.hitpoints
		value=1
		[/set_variable]
		
		[/then]

	[/if]

	[if]
		[variable]
		name=unslow_kaleh
		numerical_equals=1
		[/variable]

		[variable]
		name=unitstats.description
		equals=Kaleh
		[/variable]

		[then]

		[set_variable]
		name=unitstats.status.slowed
		value="off"
		[/set_variable]

		[/then]
	[/if]

	[unstore_unit]
	variable=unitstats
	[/unstore_unit]


	{CLEAR_VARIABLE unitstats}
		
	{NEXT i}

	{CLEAR_VARIABLE locs}

[/event]


#Initial moveto event to enter lava cavern

[event]
name=moveto

[filter]
x=38-45
y=81-84
side=1
[/filter]

[remove_shroud]
x=27-49
y=80-93
side=1
[/remove_shroud]

[remove_shroud]
x=36-45
y=92-96
side=1
[/remove_shroud]

[remove_shroud]
x=45-47
y=92-94
side=1
[/remove_shroud]

[place_shroud]
x=29-30
y=80-82
side=1
[/place_shroud]

[set_variable]
name=temp_damage
value=$heat_damage
[/set_variable]

[set_variable]
name=temp_damage
multiply=-1
[/set_variable]

[message]
speaker=unit
message= _ "Woah. This place is hot."
[/message]

[message]
speaker=unit
message= _ "This cavern is so hot it's stifling, I can already feel my armor heating up, if we tarry here too long we'll roast alive. And I don't even want to think about what would happen if I tried to walk across the lava. On the other hand, the lava does light up the cavern nicely. I think I can see several trolls waiting on the other side of the cavern."
[/message]

[message]
speaker=narrator
message= _ "Any unit that ends it's turn on a lava hex, except the Desert Shyde and Star who can fly over the lava, will take 25 damage at the beginning of the next turn. This lava damage can kill units. Desert Shydes and Stars will just take $temp_damage damage per turn when flying over lava, though they too can die if they spend too much time over lava. Also because of the heat in the cavern, all units on cave floor hexes will take $temp_damage damage at the start of each turn. This heat damage can reduce a unit to 1 hit point, but it can't kill it. "
[/message]

{CLEAR_VARIABLE temp_damage}

[unit]
	type=Troll Shaman
	description=Troll High Shaman
	x=32
	y=91
	side=7
	ai_special=guardian
	[modifications]
		{TRAIT_INTELLIGENT}
		{TRAIT_LOYAL}
	[/modifications]
[/unit]

[unit]
	type=Troll Shaman
	description=Troll High Shaman
	x=34
	y=92
	side=7
	ai_special=guardian
	[modifications]
		{TRAIT_RESILIENT}
		{TRAIT_LOYAL}
	[/modifications]
[/unit]

[object]
	id=ImmobilizeShamans
	silent=yes

	[effect]
	apply_to=movement
	set=0
	[/effect]

	[filter]
	description=Troll High Shaman
	[/filter]
	
[/object]

[set_variable]
name=summon_flame
value=2
[/set_variable]

[set_variable]
name=flame_counter
value=2
[/set_variable]

[/event]

# on a new turn, if 3 turns have passed, (or 2 turns on hard) then
# summon fire guardian, switch summon_flame back to 0

[event]
name=new turn
first_time_only=no

[set_variable]
name=flame_counter
add=1
[/set_variable]

#[message]
#	speaker=narrator
#	message= _ "SF: $summon_flame FC: $flame_counter"
#[/message]

[if]
	
	[variable]
	name=summon_flame
	numerical_equals=2
	[/variable]

	#ifdef HARD

	[variable]
	name=flame_counter
	greater_than=1
	[/variable]

	#else

	[variable]
	name=flame_counter
	greater_than=2
	[/variable]

	#endif

	[then]

	[message]
	description=Troll High Shaman
	message= _ "Arise! Arise and engulf the intruders in your holy fire!"
	[/message]

	[colour_adjust]
	red,green,blue=255,0,0
	[/colour_adjust]

	[redraw]
	[/redraw]

	[delay]
	time=100
	[/delay]

	[colour_adjust]
	red,green,blue=0,0,0
	[/colour_adjust]

	[redraw]
	[/redraw]

	#ifdef EASY
	{UNIT_ (Lava Monster) (Guardian Phoenix) 8 42 90}
	#endif

	#ifdef MEDIUM
	{UNIT_ (Lava Monster2) (Guardian Phoenix) 8 42 90}
	#endif

	#ifdef HARD
	{UNIT_ (Lava Monster2) (Guardian Phoenix) 8 42 90}
	#endif

	[scroll_to_unit]
	x,y=42,90
	[/scroll_to_unit]

	[delay]
	time=250
	[/delay]

	[message]
	side=1
	x,y=32-45,80-92
	message= _ "What the heck is that? I sure doesn't look good. The last thing we need in here is even more fire."
	[/message]

	[set_variable]
	name=summon_flame
	value=0
	[/set_variable]
	
	[/then]

	[else]

	[if]

		[variable]
		name=summon_flame
		numerical_equals=1
		[/variable]

		#ifdef HARD

		[variable]
		name=flame_counter
		greater_than=1
		[/variable]

		#else

		[variable]
		name=flame_counter
		greater_than=2
		[/variable]

		#endif

		[then]

		[colour_adjust]
		red,green,blue=255,0,0
		[/colour_adjust]

		[redraw]
		[/redraw]

		[delay]
		time=100
		[/delay]

		[colour_adjust]
		red,green,blue=0,0,0
		[/colour_adjust]

		[redraw]
		[/redraw]

		#ifdef EASY
		{UNIT_ (Lava Monster) (Guardian Phoenix) 8 42 90}
		#endif

		#ifdef MEDIUM
		{UNIT_ (Lava Monster2) (Guardian Phoenix) 8 42 90}
		#endif

		#ifdef HARD
		{UNIT_ (Lava Monster2) (Guardian Phoenix) 8 42 90}
		#endif

		[scroll_to_unit]
		x,y=42,90
		[/scroll_to_unit]

		[delay]
		time=250
		[/delay]

		[set_variable]
		name=summon_flame
		value=0
		[/set_variable]

		[message]
		side=1
		x,y=32-45,80-92
		message= _ "That thing just won't stay dead!"
		[/message]

		[/then]
	[/if]

	[/else]
[/if]

[/event]

# when fire guardian dies, switch summon_flame back to 1
# and reset flame_counter back to 0
 
[event]
name=die
first_time_only=no

[filter]
	description=Guardian Phoenix
[/filter]

[if]
	[variable]
	name=summon_flame
	less_than=3
	[/variable]

	[then]

	[set_variable]
	name=summon_flame
	value=1
	[/set_variable]

	[set_variable]
	name=flame_counter
	value=0
	[/set_variable]

	[/then]
[/if]

[/event]


# Troll shamans raise fire/rock lava monsters out of lava
# Maybe change name to "Fire Guardian" based on artwork used

# Lava monster 1: y=87
# Lava monster 2: y=94
# Lava monster 3: x=36-37 y=87-88

[event]
name=moveto

[filter]
x=37-48
y=87-94
side=1
[/filter]

#ifdef EASY
#{UNIT_ (Lava Monster) (Fire Guardian) 7 41 87}
{UNIT_ (Lava Monster) (Fire Guardian) 7 42 86}
{UNIT_ (Lava Monster) (Fire Guardian) 7 42 87}
#endif

#ifdef MEDIUM
{UNIT_ (Lava Monster) (Fire Guardian) 7 41 87}
{UNIT_ (Lava Monster) (Fire Guardian) 7 42 86}
{UNIT_ (Lava Monster) (Fire Guardian) 7 42 87}
#endif

#ifdef HARD
{UNIT_ (Lava Monster2) (Fire Guardian) 7 41 87}
{UNIT_ (Lava Monster2) (Fire Guardian) 7 42 86}
{UNIT_ (Lava Monster2) (Fire Guardian) 7 42 87}
#endif

[message]
speaker=unit
message= _ "Look, more fire spirits!"
[/message]

[/event]

[event]
name=moveto

[filter]
x=39-45
y=94-95
side=1
[/filter]

#ifdef EASY
#{UNIT_ (Lava Monster) (Fire Guardian) 7 42 90}
{UNIT_ (Lava Monster) (Fire Guardian) 7 42 91}
{UNIT_ (Lava Monster) (Fire Guardian) 7 43 91}
#endif

#ifdef MEDIUM
{UNIT_ (Lava Monster) (Fire Guardian) 7 42 90}
{UNIT_ (Lava Monster) (Fire Guardian) 7 42 91}
{UNIT_ (Lava Monster) (Fire Guardian) 7 43 91}
#endif

#ifdef HARD
{UNIT_ (Lava Monster2) (Fire Guardian) 7 42 90}
{UNIT_ (Lava Monster2) (Fire Guardian) 7 42 91}
{UNIT_ (Lava Monster2) (Fire Guardian) 7 43 91}
#endif

[message]
speaker=unit
message= _ "Oh great, even more fire spirits. When I get through this inferno I'm going to kill those trolls."
[/message]

[/event]

[event]
name=moveto

[filter]
x=28-37
y=87-88
side=1
[/filter]

#ifdef EASY
#{UNIT_ (Lava Monster) (Fire Guardian) 7 37 86}
{UNIT_ (Lava Monster) (Fire Guardian) 7 38 85}
{UNIT_ (Lava Monster) (Fire Guardian) 7 38 86}
#endif

#ifdef MEDIUM
{UNIT_ (Lava Monster) (Fire Guardian) 7 37 86}
{UNIT_ (Lava Monster) (Fire Guardian) 7 38 85}
{UNIT_ (Lava Monster) (Fire Guardian) 7 38 86}
#endif

#ifdef HARD
{UNIT_ (Lava Monster2) (Fire Guardian) 7 37 86}
{UNIT_ (Lava Monster2) (Fire Guardian) 7 38 85}
{UNIT_ (Lava Monster2) (Fire Guardian) 7 38 86}
#endif

[message]
speaker=unit
message= _ "How surprising, more fire spirits. I'm going to be really glad to get out of this cavern."
[/message]

[/event]

#at end of lava cavern, trolls come alive
[event]
name=moveto

[filter]
x=33-34,29-37
y=87-88,89-97
side=1
[/filter]

[set_variable]
name=summon_flame
value=3
[/set_variable]

[message]
x,y=34,92
message= _  "Despite the guardians of fire, the elves has almost crossed the lava!"
[/message]

[message]
x,y=32,91
message= _  "The guardians obviously aren't enough. You go alert the others and summon reinforcements. I will hold them off for as long as I can."
[/message]

[message]
x,y=34,92
message= _  "May Griknagh protect you. I'll be back soon!"
[/message]

#replace with a new troll shaman that can move
[kill]
x,y=32,91
animate=no
[/kill]

[unit]
	type=Troll Shaman
	description=Troll High Shaman
	x=32
	y=91
	side=7
	[modifications]
		{TRAIT_INTELLIGENT}
		{TRAIT_LOYAL}
	[/modifications]
[/unit]

[kill]
x,y=34,92
animate=no
[/kill]

[move_unit_fake]
type=Troll Shaman
x=34,33,32,32,33,34,35,36,37
y=92,93,93,94,95,96,97,97,98
[/move_unit_fake]


#create reinforcements for shaman to return with
# create 2 troll whelps
# on Challening and Hard add a troll shaman 

{UNIT_T (Troll Whelp2) (Troll Reinforcements) 7 43 97}
{UNIT_T (Troll Whelp2) (Troll Reinforcements) 7 44 97}

#on challenging/hard add a troll shaman

#ifdef EASY
#else

[unit]
	type=Troll Shaman
	description=Troll High Shaman
	x=42
	y=97
	side=7
	[modifications]
		{TRAIT_RESILIENT}
		{TRAIT_LOYAL}
	[/modifications]
[/unit]

#endif
[/event]


# Event 23: Trigger Troll Lord's side

[event]
name=moveto

[filter]
x=43-60
y=96-99
side=1
[/filter]

[set_variable]
	name=entered_troll_lair
	value=1
[/set_variable]

#create troll leader
[unit]
	type=Great Troll2
	description=Troll Chieftain
	canrecruit=1
	upkeep=full
	x=62
	y=91
	side=7
	[modifications]
		{TRAIT_STRONG}
		{TRAIT_RESILIENT}
	[/modifications]
[/unit]	

# lowered income of troll leader, used to be 8,10,12

[modify_side]
	side=7
		
	#ifdef EASY
	income=7
	gold=125
	#endif
	#ifdef MEDIUM
	income=9
	gold=150
	#endif
	#ifdef HARD
	income=11
	gold=175
	#endif
[/modify_side]

#capture troll chieftan's villages

[capture_village]
x,y=56,90
side=7
[/capture_village]
[capture_village]
x,y=59,89
side=7
[/capture_village]
[capture_village]
x,y=55,98
side=7
[/capture_village]
[capture_village]
x,y=61,95
side=7
[/capture_village]
[capture_village]
x,y=65,94
side=7
[/capture_village]

[/event]

#reveal cavern when player enters

[event]
name=moveto

[filter]
x=49-55
y=93-97
side=1
[/filter]

#create troll defenders

{UNIT_T (Troll Whelp2) (Troll Guard) 7 52 94}
{UNIT_T (Troll Whelp2) (Troll Guard) 7 53 98}
{UNIT_T (Troll Rocklobber2) (Troll Guard) 7 55 96}

#ifdef EASY
{UNIT_T (Troll Whelp2) (Troll Guard) 7 58 94}
#else
{UNIT_T (Troll2) (Troll Guard) 7 58 94}
#endif


[remove_shroud]
x=49-66
y=88-98
side=1
[/remove_shroud]

[unit]
type=Troll Shaman
description=High Advisor
upkeep=free
x=61
y=93
side=7
ai_special=guardian
[modifications]
	{TRAIT_LOYAL}
	{TRAIT_RESILIENT}
[/modifications]
[/unit]

[message]
description=High Advisor
message= _ "Invade our most holy cavern at your peril. Long have we protected our sacred burial grounds from your foul kind, and we shall scatter your bones next to those of our ancestors."
[/message]

[message]
description=Troll Chieftain
message= _ "Destroy the invaders; make them pay for their slaughter!"
[/message]

[/event]

# Event 24: Troll Undead Uprising 

#define TROLL_UNDEAD_UPRISING

[message]
description=High Advisor
message= _ "Arise our brothers of ages past, arise and destroy the intruders!"
[/message]

{UNIT_ (Troll Zombie) () 7 55 91}
{UNIT_ (Troll Zombie) () 7 56 97}
{UNIT_ (Troll Zombie) () 7 52 92}
{UNIT_ (Troll Zombie) () 7 53 98}

#ifdef MEDIUM

{UNIT_ (Troll Zombie) () 7 49 94}
{UNIT_ (Troll Zombie) () 7 50 97}

#endif

#ifdef HARD
{UNIT_ (Troll Zombie) () 7 58 90}
{UNIT_ (Troll Zombie) () 7 59 95}

#endif

#enddef

# count number of elves that have entered the trolls cave. Once 3 elves
# are in the cave, then active the troll undead uprising

[event]
name=new turn
first_time_only=no

[store_locations]
	x=51-66
	y=92-98
	[filter]
	side=1
	[/filter]
	variable=troll_list
[/store_locations]

[set_variable]
	name=temp
	value=$troll_list.length
[/set_variable]

{CLEAR_VARIABLE troll_list}

[if]
	[variable]
	name=temp
	greater_than_equal_to=3
	[/variable]

	[then]

	[if]
		[variable]
		name=troll_undead_arose
		numerical_equals=0
		[/variable]

		[then]

		{TROLL_UNDEAD_UPRISING}

		[set_variable]
		name=troll_undead_arose
		value=1
		[/set_variable]

		[/then]
	[/if]

	[/then]
[/if]

[/event]

[event]
name=die

[filter]
	description=Troll Chieftain
[/filter]

[message]
description=Troll Chieftain
message= _ "Argh! Cure you! May you never leave these tunnels alive!"
[/message]

[message]
speaker=second_unit
message= _ "And so, at last, it ends."
[/message]

[message]
side=7
message= _ "Da big troll is dead. Run for your lives!"
[/message]

[kill]
side=7
animate=no
[/kill]

[terrain]
x=57,57,58,59,60,61,61
y=84,85,85,86,86,87,88
letter=u
[/terrain]

[move_unit_fake]
type=Dwarvish Scout
x=57,57,58,59,60,61,61
y=84,85,85,86,86,87,88
[/move_unit_fake]

{UNIT_ (Dwarvish Pathfinder) (Grendel) 5 61 88}

[remove_shroud]
	x=59-62
	y=86-89
	side=1
[/remove_shroud]

[delay]
time=200
[/delay]

[message]
description=Grendel
message= _ "With the death of their leader the foul trolls have retreated. This war is far from over, but with your help we won the first battle. You have our gratitude. Our King has instructed us to bring you to him, he wants to talk with you and reward you. He waits in our most hallowed halls, a place that no elf has seen for generations upon generations. It is a great honor, but you have done great deeds this day. Elves killing the troll chieftain! We will tell this story for years."
[/message]

[message]
description=Nym
message= _ "You think they could have told us about all these secret tunnels beforehand. It would have saved us a lot of unnecessary fighting in actually getting to the great troll."
[/message]

[message]
description=Zhul
message= _ "I think they wanted to further test our prowess in battle. And perhaps they didn't entirely trust us with all their secrets."
[/message]

[message]
description=Kaleh
message= _ "Shhhh, you two. Yes, of course, we would be honored to come and meet your chieftain. But we left many of our people back up the passageway and I fear that even now these caves aren't safe. Can you help us escort my people to safety?"
[/message]

[message]
description=Grendel
message= _ "Hmmmm, yes, after what you have done, I think I could arrange something. We have a few larger caves that should hold your people, a bit cramped, but safe. Since you first arrived, we've had a few lads watch over them, you hid your folk in a good defensive location, but you can never be too sure. I'll get them to help escort your people to safety. We certainly wouldn't want any surprises."
[/message]

[message]
description=Kaleh
message= _ "You are full of surprises. But I feel better knowing a few of your kind we watching out for the rest of my people. All right everyone, no celebrating yet, we still have work left to do!"
[/message]

[endlevel]
result=victory
next_scenario="DwarfInterlude"
bonus=yes
[/endlevel]

[/event]

# TROLL EASTER EGG EVENTS

# Event 25: Dwarf Ghost

# this event doesn't work. I'm trying to immobilize the ghost.
# right now using an object effect to set moves=0 freezes the game

#[event]
#name=side turn
#first_time_only=no

#	[store_unit]
#		[filter]
#			description=Dwarf Ghost		
#		[/filter]	
#		variable=ghostvar
#	[/store_unit]

#	[set_variable]
#	name=ghostvar.moves
#	value=0
#	[/set_variable]

#	[unstore_unit]
#	variable=ghostvar
#	[/unstore_unit]

#	{CLEAR_VARIABLE ghostvar}

#[/event]


[event]
name=moveto
first_time_only=no

[filter]
x=23-27
y=86-90
side=1
[/filter]

[if]

	[variable]
	name=buried_dwarf
	numerical_equals=0
	[/variable]

	[then]

	[if]
		[variable]
		name=met_ghost
		numerical_equals=0
		[/variable]

		[then]

		[set_variable]
		name=met_ghost
		value=1
		[/set_variable]

		[remove_shroud]
		x=23-28
		y=86-90
		side=1
		[/remove_shroud]
	
		[message]
		speaker=unit
		message= _ "It's cooler here, there seems to be a draft to the west."
		[/message]

		{UNIT_ (Haunt) (Dwarf Ghost) 4 24 89} 

		[delay]
		time=300
		[/delay]

		[message]
		description=Dwarf Ghost
		message= _ "Hail, friend elf. Ages ago, I too fought the trolls and came to this place. But by ill luck I was burned to the death by the lava and died nearby unblessed and unhonored. Find my body and grant me the peace I so dearly wish for. Do this and I will let you pass."
		[/message]

		[/then]
	[/if]

	[/then]

	[else]

	[message]
	description=Dwarf Ghost
	message= _ "Thank you. You have done for me what all my dwarven kin never did. May Moradin bless you and watch over you. I leave now for the halls of my ancestors..."
	[/message]

	[kill]
	description=Dwarf Ghost
	animate=yes
	[/kill]

	[/else]
	
[/if]

[/event]

# Event 26: Dwarf Corpse

[event]
name=moveto
first_time_only=no

[filter]
x=30
y=81-82
side=1
[/filter]

[if]
	[variable]
	name=met_ghost
	numerical_equals=1
	[/variable]

	[then]

	[message]
	speaker=unit
	message= _ "Look, a crumbling skeleton. I think this might be the body of the dwarven ghost. It shouldn't take long to dig a shallow grave."
	[/message]

	[redraw]
	[/redraw]

	[delay]
	time=1000
	[/delay]

	[message]
	speaker=unit
	message= _ "May Eloh, or whatever god you worship, grant you peace and safe passage to the afterlife. We will avenge your death."
	[/message]

	[set_variable]
	name=buried_dwarf
	value=1
	[/set_variable]

	[set_variable]
	name=met_ghost
	value=2
	[/set_variable]	
	
	[/then]
[/if]

[/event]

# Event 27: Troll Guardian
[event]
name=moveto

[filter]
x=23-25
y=89-94
side=1
[/filter]

{UNIT_ (Troll Zombie) (Crypt Guardian) 7 23 94}

[message]
speaker=unit
message= _ "This looks like a troll crypt. Whoever it was must have been very important, because they have their own undead guardian."
[/message]

[/event]

# Event 28: Troll Coffin

[event]
name=moveto

[filter]
x=21-22
y=95
side=1
[/filter]

[message]
speaker=unit
message= _ "There is a chasm here cutting off the end of the crypt. It must be rather recent, it cuts off the path leading to a rather ornate stone coffin."
[/message]

[/event]

# Ransack Troll Coffin

[event]
name=moveto
first_time_only=no

[filter]
x=19
y=97
side=1
[/filter]

[if]

	[variable]
	name=took_wand
	numerical_equals=0
	[/variable]

	[then]

	[message]
	speaker=unit
		
	message= _ "For a troll this is quite an ornate tomb. The coffin itself is quite impressive. Inside the skeleton has crumbled to dust, and there are a few colored stones and trinkets, but what really sticks out is this emerald wand. I don't have much experience with magical items, but the asp with emerald eyes and large fangs carved around it's shaft leave little doubt as to its power. We don't normally tolerate using poison, but extreme circumstances call for extreme measures and I have feeling we may find this useful before our journey is over."
	[option]	
		message= _ "It might be useful, I'll take it."
		[command]
			[set_variable]
			name=took_wand
			value=1
			[/set_variable]		
		[/command]
		[command]
			[message]
			speaker=unit
			message= _ "The wand fit comfortably in my hand. It doesn't seem to have much of a range, but in close combat it could be quite useful."
			[/message]	
		[/command]
					
		[command]

			[object]

			[filter]
			x=19
			y=97
			side=1
			[/filter]
			
			id=Troll Wand
			name="Emerald Wand of Poison"
			description="This wand make this unit's melee attacks deal poison damage."
			
			[effect]
			apply_to=attack
			range=short
			set_special=poison
			[/effect]

			#[effect]
			#apply_to=new_attack
			#name=poison wand
			#type=cold
			#icon=attacks/dark-missle.png
			#special=poison, magical
			#range=long
			#damage=5
			#number=2
			#[/effect]
 
			[/object]		
		[/command]						
	[/option]
		
	[option]
	message= _ "On second thought, it's better to leave the dead in peace."
	
	[/option]

	[/message]

	[/then]
[/if]

[/event]

# Event 29: Return of the Assassin

#define ASSASSIN_MACRO2 X_LOC Y_LOC

		[set_variable]
		name=found_empty_hex
		value=1
		[/set_variable]

		[store_locations]
		x={X_LOC}
		y={Y_LOC}
		[filter]
			side=1
		[/filter]
		variable=temp
		[/store_locations]

		[set_variable]
		name=unit_in_hex
		value=$temp.length
		[/set_variable]

		[store_unit]
		[filter]
			x={X_LOC}
			y={Y_LOC}		
		[/filter]	
			variable=elf_var
		[/store_unit]

		[kill]
		x,y={X_LOC},{Y_LOC}
		animate=no
		fire_event=no
		[/kill]
		
		{UNIT_ (Dark Assassin2) (Cloaked Figure) 9 {X_LOC} {Y_LOC}}

		# kill/store occupant if there is one
		# place assassin

		[message]
		description=Cloaked Figure
		message= _ "Did you think you escaped me Kaleh? I am your shadow, I will always be there until you pay for what you have done."
		[/message]

		[hide_unit]
		x,y={X_LOC},{Y_LOC}
		[/hide_unit]

		[redraw]
		[/redraw]

		{PUT_IMG orcish-nightstalker-ranged-1.png {X_LOC} {Y_LOC}}

		[redraw]
		[/redraw]

		[delay]
		time=250
		[/delay]

		[removeitem]
		x={X_LOC}
		y={Y_LOC}
		[/removeitem]
	
		{PUT_IMG orcish-nightstalker-ranged-2.png {X_LOC} {Y_LOC}}

		[redraw]
		[/redraw]

		[delay]
		time=250
		[/delay]

		[removeitem]
		x={X_LOC}
		y={Y_LOC}
		[/removeitem]

		[unhide_unit]
		[/unhide_unit]

		[store_unit]
		[filter]
			description=Kaleh
		[/filter]
		variable=unitstats
		[/store_unit]

		[set_variable]
		name=unitstats.status.slowed
		value="on"
		[/set_variable]

		[unstore_unit]
		variable=unitstats
		[/unstore_unit]

		{CLEAR_VARIABLE unitstats}

		[object]
			[filter]
				description=Kaleh
			[/filter]
			
			id=SlowKaleh
			silent=yes

			#ifdef EASY
			[effect]
				apply_to=hitpoints
				increase=-25%
			[/effect]
			#endif

			#ifdef MEDIUM
			[effect]
				apply_to=hitpoints
				increase=-33%
			[/effect]
			#endif

			#ifdef HARD
			[effect]
				apply_to=hitpoints
				increase=-50%
			[/effect]
			#endif


		[/object]

		[message]
		description=Kaleh
		message= _ "Ow!"
		[/message]

		[message]
		description=Cloaked Figure
		message= _ "You want to flee, don't you? But you cannot. They couldn't escape her either. Even death could not save them. She will devour us all. But first I shall have my revenge. Do the dance of death for me Kaleh! Dance! Dance!"
		[/message]

#enddef


#Find empty hex and create assassin

[event]
name=new turn
first_time_only=no

[if]
	[variable]
	name=call_assassin
	numerical_equals=1
	[/variable]

[then]

	[set_variable]
	name=call_assassin
	value=2
	[/set_variable]

# find location of Kaleh
 
[store_locations]
	x=1-67
	y=1-99
	radius=1000
	[filter]
		description="Kaleh"
	[/filter]
	variable=kaleh_loc
[/store_locations]

[set_variable]
	name=kaleh_x
	to_variable=kaleh_loc[0].x
[/set_variable]
		
[set_variable]
	name=kaleh_y
	to_variable=kaleh_loc[0].y
[/set_variable]

{CLEAR_VARIABLE kaleh_loc}

# find adjacent hex with cave floor or dirt

# test these hexes

# x+0 y+1

[if]
	[variable]
	name=found_empty_hex
	numerical_equals=0
	[/variable]

	[then]

	[set_variable]
	name=temp_x
	value=$kaleh_x
	[/set_variable]

	[set_variable]
	name=temp_y
	value=$kaleh_y
	[/set_variable]

	[set_variable]
	name=temp_y
	add=1
	[/set_variable]

	[store_locations]
		x=$temp_x
		y=$temp_y
		terrain=urD
		variable=hex_loc
	[/store_locations]

	[set_variable]
	name=temp
	value=$hex_loc.length
	[/set_variable]

	{CLEAR_VARIABLE hex_loc}

	[if]
		[variable]
		name=temp
		numerical_equals=1
		[/variable]

		[then]
	
		{ASSASSIN_MACRO2 $temp_x $temp_y}

		[/then]
	[/if]

	[/then]

[/if]


# x+1 y+0
[if]
	[variable]
	name=found_empty_hex
	numerical_equals=0
	[/variable]

	[then]

	[set_variable]
	name=temp_x
	value=$kaleh_x
	[/set_variable]

	[set_variable]
	name=temp_y
	value=$kaleh_y
	[/set_variable]

	[set_variable]
	name=temp_x
	add=1
	[/set_variable]

	[store_locations]
		x=$temp_x
		y=$temp_y
		terrain=urD
		variable=hex_loc
	[/store_locations]

	[set_variable]
	name=temp
	value=$hex_loc.length
	[/set_variable]

	{CLEAR_VARIABLE hex_loc}

	[if]
		[variable]
		name=temp
		numerical_equals=1
		[/variable]

		[then]
	
		{ASSASSIN_MACRO2 $temp_x $temp_y}

		[/then]
	[/if]

	[/then]
[/if]

# x+0 y-1

[if]
	[variable]
	name=found_empty_hex
	numerical_equals=0
	[/variable]

	[then]

	[set_variable]
	name=temp_x
	value=$kaleh_x
	[/set_variable]

	[set_variable]
	name=temp_y
	value=$kaleh_y
	[/set_variable]

	[set_variable]
	name=temp_y
	add=-1
	[/set_variable]

	[store_locations]
		x=$temp_x
		y=$temp_y
		terrain=urD
		variable=hex_loc
	[/store_locations]

	[set_variable]
	name=temp
	value=$hex_loc.length
	[/set_variable]

	{CLEAR_VARIABLE hex_loc}

	[if]
		[variable]
		name=temp
		numerical_equals=1
		[/variable]

		[then]
	
		{ASSASSIN_MACRO2 $temp_x $temp_y}

		[/then]
	[/if]

	[/then]
[/if]

# x-1 y+0

[if]
	[variable]
	name=found_empty_hex
	numerical_equals=0
	[/variable]

	[then]

	[set_variable]
	name=temp_x
	value=$kaleh_x
	[/set_variable]

	[set_variable]
	name=temp_y
	value=$kaleh_y
	[/set_variable]

	[set_variable]
	name=temp_x
	add=-1
	[/set_variable]

	[store_locations]
		x=$temp_x
		y=$temp_y
		terrain=urD
		variable=hex_loc
	[/store_locations]

	[set_variable]
	name=temp
	value=$hex_loc.length
	[/set_variable]

	{CLEAR_VARIABLE hex_loc}

	[if]
		[variable]
		name=temp
		numerical_equals=1
		[/variable]

		[then]
	
		{ASSASSIN_MACRO2 $temp_x $temp_y}

		[/then]
	[/if]

	[/then]
[/if]

# x+1 y+1 

[if]
	[variable]
	name=found_empty_hex
	numerical_equals=0
	[/variable]

	[then]

	[set_variable]
	name=temp_x
	value=$kaleh_x
	[/set_variable]

	[set_variable]
	name=temp_y
	value=$kaleh_y
	[/set_variable]

	[set_variable]
	name=temp_x
	add=1
	[/set_variable]

	[set_variable]
	name=temp_y
	add=1
	[/set_variable]

	[store_locations]
		x=$temp_x
		y=$temp_y
		terrain=urD
		variable=hex_loc
	[/store_locations]

	[set_variable]
	name=temp
	value=$hex_loc.length
	[/set_variable]

	{CLEAR_VARIABLE hex_loc}

	[if]
		[variable]
		name=temp
		numerical_equals=1
		[/variable]

		[then]
	
		{ASSASSIN_MACRO2 $temp_x $temp_y}

		[/then]
	[/if]	

	[/then]
[/if]

# x+1 y-1

[if]
	[variable]
	name=found_empty_hex
	numerical_equals=0
	[/variable]

	[then]

	[set_variable]
	name=temp_x
	value=$kaleh_x
	[/set_variable]

	[set_variable]
	name=temp_y
	value=$kaleh_y
	[/set_variable]

	[set_variable]
	name=temp_x
	add=1
	[/set_variable]

	[set_variable]
	name=temp_y
	add=-1
	[/set_variable]

	[store_locations]
		x=$temp_x
		y=$temp_y
		terrain=urD
		variable=hex_loc
	[/store_locations]

	[set_variable]
	name=temp
	value=$hex_loc.length
	[/set_variable]

	{CLEAR_VARIABLE hex_loc}

	[if]
		[variable]
		name=temp
		numerical_equals=1
		[/variable]

		[then]
	
		{ASSASSIN_MACRO2 $temp_x $temp_y}

		[/then]
	[/if]

	[/then]
[/if]

# x-1 y+1

[if]
	[variable]
	name=found_empty_hex
	numerical_equals=0
	[/variable]

	[then]

	[set_variable]
	name=temp_x
	value=$kaleh_x
	[/set_variable]

	[set_variable]
	name=temp_y
	value=$kaleh_y
	[/set_variable]

	[set_variable]
	name=temp_x
	add=-1
	[/set_variable]

	[set_variable]
	name=temp_y
	add=1
	[/set_variable]

	[store_locations]
		x=$temp_x
		y=$temp_y
		terrain=urD
		variable=hex_loc
	[/store_locations]

	[set_variable]
	name=temp
	value=$hex_loc.length
	[/set_variable]

	{CLEAR_VARIABLE hex_loc}

	[if]
		[variable]
		name=temp
		numerical_equals=1
		[/variable]

		[then]
	
		{ASSASSIN_MACRO2 $temp_x $temp_y}

		[/then]
	[/if]

	[/then]
[/if]

# x-1 y-1 

[if]
	[variable]
	name=found_empty_hex
	numerical_equals=0
	[/variable]

	[then]

	[set_variable]
	name=temp_x
	value=$kaleh_x
	[/set_variable]

	[set_variable]
	name=temp_y
	value=$kaleh_y
	[/set_variable]

	[set_variable]
	name=temp_x
	add=-1
	[/set_variable]

	[set_variable]
	name=temp_y
	add=-1
	[/set_variable]

	[store_locations]
		x=$temp_x
		y=$temp_y
		terrain=urD
		variable=hex_loc
	[/store_locations]

	[set_variable]
	name=temp
	value=$hex_loc.length
	[/set_variable]

	{CLEAR_VARIABLE hex_loc}

	[if]
		[variable]
		name=temp
		numerical_equals=1
		[/variable]

		[then]
	
		{ASSASSIN_MACRO2 $temp_x $temp_y}

		[/then]
	[/if]

	[/then]
[/if]

	[/then]
[/if]

[/event]

# Each turn check to see if the assassin is alive.
# If he is then keep Kaleh slowed.

[event]
name=new turn
first_time_only=no

	[if]
		[have_unit]
		description=Cloaked Figure
		[/have_unit]

		[then]
		[store_unit]
		[filter]
			description=Kaleh
		[/filter]
		variable=unitstats
		[/store_unit]

		[set_variable]
		name=unitstats.status.slowed
		value="on"
		[/set_variable]

		[unstore_unit]
		variable=unitstats
		[/unstore_unit]

		[/then]
	[/if]

[/event]


#when assassin dies, return original occupant of hex if there was one
[event]
name=die

[filter]
description=Cloaked Figure
[/filter]

# for some reason right after the cloaked figure dies and the
# vanished elf reappears, if that unit was a hero then their
# death event is called, even though the hero doesn't die. This
# variable is used to make sure that if the death event is accidentally
# called, then it does nothing. (and doesn't end the scenario)

[set_variable]
	name=immortal_hero
	value=1
[/set_variable]

[set_variable]
	name=unslow_kaleh
	value=1
[/set_variable]

[kill]
description=Cloaked Figure
animate=no
fire_event=no
[/kill]

[message]
description=Kaleh
message= _ "Where did he go? How does he disappear like that?  And what in Zardia's name was he ranting about? Whoever that is is starting to make me get edgy."
[/message]

#restore original occupant of hex, if there was one

[unstore_unit]
variable=elf_var
find_vacant=yes
[/unstore_unit]

[if]
	
	[variable]
	name=unit_in_hex
	numerical_equals=1
	[/variable]

	[then]

	[message]
	description=$elf_var.description
	message= _ "Huh? What happened?"
	[/message]

	[message]
	description=Kaleh
	message= _ "Where did you go? Do you remember anything?"
	[/message]

	[message]
	description=$elf_var.description
	message= _ "No, someone grabbed me and knocked me out. I have no idea who it was."
	[/message]
	
	[/then]
[/if]

{CLEAR_VARIABLE elf_var}

[/event]


#at victory, clear variables:
[event]
name=victory

{CLEAR_VARIABLE i}
{CLEAR_VARIABLE number_enemies}
{CLEAR_VARIABLE battle_turn_counter}
{CLEAR_VARIABLE saw_cairn_or_totem}
{CLEAR_VARIABLE dead_dwarf_leaders}
{CLEAR_VARIABLE dead_troll_leaders}
{CLEAR_VARIABLE first_tunnel}
{CLEAR_VARIABLE bridge_blown}
{CLEAR_VARIABLE temp}
{CLEAR_VARIABLE tempx}
{CLEAR_VARIABLE tempy}
{CLEAR_VARIABLE tentacle_count}
{CLEAR_VARIABLE tentacle_deaths}
{CLEAR_VARIABLE tripped_bats}
{CLEAR_VARIABLE x_left}
{CLEAR_VARIABLE x_right}
{CLEAR_VARIABLE y_up}
{CLEAR_VARIABLE y_down}
{CLEAR_VARIABLE dwarf_door}
{CLEAR_VARIABLE dwarf_amulet}
{CLEAR_VARIABLE took_belt}

{CLEAR_VARIABLE lava_damage}
{CLEAR_VARIABLE heat_damage}
{CLEAR_VARIABLE summon_flame}
{CLEAR_VARIABLE flame_counter}
{CLEAR_VARIABLE troll_undead_arose}
{CLEAR_VARIABLE met_ghost}
{CLEAR_VARIABLE buried_dwarf}
{CLEAR_VARIABLE took_wand}
{CLEAR_VARIABLE entered_dwarf_lair}
{CLEAR_VARIABLE entered_troll_lair}

{CLEAR_VARIABLE assassin_turn}
{CLEAR_VARIABLE call_assassin}
{CLEAR_VARIABLE found_empty_hex}

{CLEAR_VARIABLE saw_interrogators}
{CLEAR_VARIABLE saw_sergeant}

{CLEAR_VARIABLE immortal_hero}
{CLEAR_VARIABLE unit_in_hex}
{CLEAR_VARIABLE unslow_kaleh}
{CLEAR_VARIABLE unitstats}


[/event]

[event]
name=time over

[message]
description=Kaleh
message= _ "Oh no, we took too long and enemy reinforcements have arrived. We'll surely be overwhelmed now!"
[/message]

[/event]

#if troll/dwarf prisoner (Rogrimir & Grog) die in battle, record it

[event]
name=die

[filter]
description=Rogrimir
[/filter]

[set_variable]
name=rog_died
value=1
[/set_variable]

[/event]

[event]
name=die

[filter]
description=Grog
[/filter]

[set_variable]
name=grog_died
value=1
[/set_variable]

[/event]

{@campaigns/Under_the_Burning_Suns/misc/deaths.cfg} 

[/scenario]
